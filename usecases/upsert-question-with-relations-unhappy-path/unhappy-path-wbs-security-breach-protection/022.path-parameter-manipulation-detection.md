# US-022: Path Parameter Manipulation Detection

## User Story
**As a** system security administrator
**I want** automatic detection of path parameter manipulation attacks
**So that** malicious users cannot access other users' question banks by modifying URL parameters

## Epic
Security Breach Protection

## Story
Implement sophisticated path parameter manipulation detection integrated with US-020 SecurityContextValidator

## Acceptance Criteria

### Attack Detection
- [ ] **AC-022.1**: System must detect when JWT token user ID differs from path parameter userId
- [ ] **AC-022.2**: System must detect attempts to access questionbankId not owned by authenticated user
- [ ] **AC-022.3**: Detection must occur before any business logic processing
- [ ] **AC-022.4**: All manipulation attempts must be immediately blocked and logged

### Security Response
- [ ] **AC-022.5**: Failed validation must return HTTP 403 Forbidden status
- [ ] **AC-022.6**: Error response must provide minimal information to prevent information disclosure
- [ ] **AC-022.7**: Security event must be logged via US-021 SecurityAuditLogger
- [ ] **AC-022.8**: Repeated attempts from same user must trigger progressive rate limiting

### Integration Requirements
- [ ] **AC-022.9**: Detection logic must integrate with US-020 SecurityContextValidator
- [ ] **AC-022.10**: Must leverage existing ownership validation from US-003 enhanced validators
- [ ] **AC-022.11**: Must use existing RetryHelper from US-003 for resilient validation operations
- [ ] **AC-022.12**: Performance impact must be <15ms per request

## Technical Requirements

### Detection Algorithm
```java
public class PathParameterManipulationDetector {

    public SecurityValidationResult detectManipulation(UpsertQuestionCommand command, SecurityContext authContext) {
        // 1. Extract token user ID
        Long tokenUserId = extractUserIdFromToken(authContext);

        // 2. Compare with path parameter
        if (!tokenUserId.equals(command.getUserId())) {
            return SecurityValidationResult.violation(
                SecurityEventType.PATH_PARAMETER_MANIPULATION,
                String.format("Token user ID %d does not match path userId %d",
                    tokenUserId, command.getUserId())
            );
        }

        // 3. Validate question bank ownership
        if (!validateQuestionBankOwnership(command.getUserId(), command.getQuestionBankId())) {
            return SecurityValidationResult.violation(
                SecurityEventType.UNAUTHORIZED_ACCESS_ATTEMPT,
                String.format("User %d does not own question bank %d",
                    command.getUserId(), command.getQuestionBankId())
            );
        }

        return SecurityValidationResult.success();
    }
}
```

### Attack Scenario Coverage
1. **User ID Manipulation**: Changing userId in path to access other users' data
2. **Question Bank ID Manipulation**: Accessing question banks not owned by user
3. **Combined Manipulation**: Both userId and questionbankId tampering
4. **Privilege Escalation**: Valid users attempting to access admin-level resources

### Integration Points
- **US-020**: SecurityContextValidator calls detection logic
- **US-021**: SecurityAuditLogger records all manipulation attempts
- **US-003**: Enhanced QuestionBankOwnershipValidator for ownership checks

## Business Rules

### Security Detection Rules
1. **Zero Tolerance**: Any path parameter manipulation attempt is immediately blocked
2. **Comprehensive Logging**: All attempts logged with full context for investigation
3. **Rate Limiting**: Progressive penalties for repeated manipulation attempts
4. **Information Protection**: Error responses reveal minimal system information

### Response Strategy
- **Immediate Block**: No processing of manipulated requests
- **Audit Trail**: Complete forensic information for security investigation
- **User Notification**: Log security events for user account monitoring
- **System Protection**: Automatic defensive measures for repeated attacks

## Definition of Done

### Implementation Complete
- [ ] PathParameterManipulationDetector class implemented
- [ ] User ID vs token validation logic implemented
- [ ] Question bank ownership validation enhanced
- [ ] Integration with US-020 SecurityContextValidator completed

### Security Coverage
- [ ] All path parameter manipulation scenarios tested
- [ ] Attack detection accuracy validated through security testing
- [ ] False positive rate verified <1% for legitimate requests
- [ ] Response time impact verified <15ms per request

### Testing Complete
- [ ] Unit tests covering all manipulation attack scenarios
- [ ] Integration tests using legitimate and malicious request patterns
- [ ] Performance tests validating detection speed requirements
- [ ] Security penetration testing with manipulation attempts

### Monitoring and Alerting
- [ ] Security event logging integrated with US-021 system
- [ ] Manipulation attempt metrics collected and reported
- [ ] Real-time alerting configured for security team
- [ ] Forensic data collection verified for incident investigation

## Dependencies

### Prerequisites
- **US-020**: SecurityContextValidator (integration point for detection logic)
- **US-021**: SecurityAuditLogger (security event logging)
- **US-003**: Enhanced validation chain with ownership validation
- **US-005**: Repository layer for question bank ownership queries

### External Dependencies
- Spring Security JWT token processing
- HTTP request context for user identification
- Rate limiting infrastructure for progressive penalties

## Risk Mitigation

### Security Risks
- **Detection Evasion**: Comprehensive test coverage of manipulation techniques
- **False Positives**: Thorough testing with legitimate user scenarios
- **Performance Impact**: Optimized detection algorithms with caching
- **Information Disclosure**: Minimal error responses to prevent reconnaissance

### Operational Risks
- **System Disruption**: Gradual rollout with monitoring and rollback capability
- **Investigation Capability**: Complete audit trails for forensic analysis
- **Scalability**: Detection logic designed for high-throughput scenarios
- **Maintenance**: Clear documentation and alerting for security team

## Success Metrics

### Security Effectiveness
- 100% detection rate for path parameter manipulation attempts
- <1% false positive rate for legitimate user requests
- <15ms detection processing time per request
- Zero successful unauthorized access attempts

### System Integration
- All existing functionality remains operational
- Security detection integrates seamlessly with US-020 validator
- Audit logging captures 100% of manipulation attempts
- Performance impact <2% on overall system response time

### Operational Success
- Security team receives timely alerts for manipulation attempts
- Forensic data sufficient for incident investigation and response
- Progressive rate limiting effectively deters repeated attack attempts
- Zero compliance violations or security audit findings