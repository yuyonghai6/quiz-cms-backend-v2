# Use Case Description and Design - Quiz Assembly

## 1. Use Case Overview

### 1.1 Use Case ID
**UC-QA-001**: Create Quiz Assembly from Selected Questions

### 1.2 Use Case Name
**Quiz Assembly Generation from Question Bank Selection**

### 1.3 Primary Actor
Course Creator (authenticated user with access to question banks)

### 1.4 Secondary Actors
- Quiz Management System
- Question Bank Service
- MongoDB Database

### 1.5 Stakeholders and Interests
- **Course Creator**: Wants to efficiently create quiz assemblies from existing questions
- **Students**: Will benefit from well-structured quiz assemblies
- **System Administrator**: Needs reliable, performant quiz assembly operations
- **Content Manager**: Requires audit trail and version control of quiz assemblies

### 1.6 Scope
Backend API service for creating and retrieving quiz assemblies with full CRUD operations and multi-tenant support.

## 2. Use Case Description

### 2.1 Brief Description
Course creators can select multiple questions from their question bank via a dashboard interface and combine them into a single quiz assembly document. The system supports both creation of new quiz assemblies and updating existing ones (upsert operations).

### 2.2 Detailed Flow Description

#### Primary Success Scenario - Create Quiz Assembly
1. **Course Creator Access**: User accesses their question bank dashboard
2. **Question Selection**: User selects multiple questions using checkboxes
3. **Assembly Initiation**: User clicks "Add these questions to a single quiz" button
4. **Frontend Request**: Frontend sends POST request to quiz assembly API
5. **Authentication & Authorization**: System validates user permissions
6. **Question Validation**: System verifies all selected questions exist and belong to user
7. **Quiz Assembly Creation**: System creates QuizAssemblyAggregate with question snapshots
8. **Data Persistence**: System stores quiz assembly to MongoDB
9. **Response Generation**: System returns success response with assembly details
10. **UI Update**: Frontend displays newly created quiz assembly

#### Alternative Scenarios

**Alternative 1: Update Existing Quiz Assembly**
- Steps 1-4 same as primary scenario
- Step 5: System detects existing quiz_assembly_id
- Step 6: System validates user owns existing assembly
- Step 7: System updates existing assembly with new question selection
- Steps 8-10: Same as primary scenario

**Alternative 2: Retrieve Quiz Assembly**
1. User requests specific quiz assembly by ID
2. System validates ownership and permissions
3. System retrieves quiz assembly from MongoDB
4. System returns complete assembly data including question snapshots

### 2.3 Preconditions
- User is authenticated and has valid session
- User has at least one active question bank
- Selected questions exist in user's question bank
- Questions are in 'published' status
- System has connectivity to MongoDB

### 2.4 Postconditions
**Success Postconditions:**
- Quiz assembly document is created/updated in MongoDB
- Question snapshots are embedded in assembly
- User can retrieve the assembly via GET API
- System logs successful operation

**Failure Postconditions:**
- No data is modified in case of validation errors
- Error details are returned to client
- System logs error for debugging
- Transaction is rolled back if needed

## 3. Functional Requirements

### 3.1 Core Functional Requirements

#### FR-1: Quiz Assembly Creation
- **ID**: FR-QA-001
- **Description**: System shall create quiz assemblies from selected questions
- **Input**: User ID, Question Bank ID, Quiz Assembly ID (UUID v7), selected question IDs, metadata
- **Processing**: Validate inputs, retrieve questions, create aggregate, persist to MongoDB
- **Output**: Quiz assembly response with embedded question data

#### FR-2: Quiz Assembly Retrieval
- **ID**: FR-QA-002
- **Description**: System shall retrieve quiz assemblies by ID
- **Input**: User ID, Question Bank ID, Quiz Assembly ID
- **Processing**: Validate ownership, query MongoDB, map to response DTO
- **Output**: Complete quiz assembly data including question snapshots

#### FR-3: Quiz Assembly Update (Upsert)
- **ID**: FR-QA-003
- **Description**: System shall support update of existing quiz assemblies
- **Input**: Existing Quiz Assembly ID with updated question selection
- **Processing**: Validate ownership, update aggregate, persist changes
- **Output**: Updated quiz assembly response

#### FR-4: Question Snapshot Management
- **ID**: FR-QA-004
- **Description**: System shall embed question snapshots to ensure data integrity
- **Input**: Source question data from question-bank module
- **Processing**: Create immutable snapshots of essential question data
- **Output**: Quiz assembly with embedded question snapshots

### 3.2 Business Rules

#### BR-1: User Ownership Validation
- Users can only create quiz assemblies within their own question banks
- Users can only access quiz assemblies they have created
- Question bank ownership is validated against question_banks_per_user collection

#### BR-2: Question Existence Validation
- All selected questions must exist in the specified question bank
- Questions must belong to the requesting user
- Questions must be in 'published' status to be included in assemblies

#### BR-3: Quiz Assembly Uniqueness
- Quiz Assembly ID must be unique within user's question bank scope
- System uses compound unique index: (user_id, question_bank_id, quiz_assembly_id)
- Duplicate assembly IDs within same scope are rejected

#### BR-4: Question Snapshot Integrity
- Question snapshots are immutable once created
- Snapshots include essential data: type, title, content, points, status
- Original question changes do not affect existing quiz assemblies

#### BR-5: Data Validation Rules
- Quiz Assembly ID must be valid UUID v7 format
- Question Bank ID must be valid UUID v7 format
- Source Question IDs must be valid UUID v7 format
- User ID must be valid Long format
- Quiz metadata must meet minimum requirements (title, description)

### 3.3 Data Integrity Requirements

#### DI-1: Transactional Consistency
- Quiz assembly operations must be atomic
- Failure during question retrieval rolls back entire operation
- Database constraints are enforced at MongoDB level

#### DI-2: Multi-Tenant Isolation
- Complete data separation between users
- All queries include user_id filter
- Question bank access is validated per user

#### DI-3: Referential Integrity
- Question snapshots maintain reference to original question ID
- Question snapshots preserve essential data even if original is deleted
- Assembly metadata includes creation and modification timestamps

## 4. Non-Functional Requirements

### 4.1 Performance Requirements

#### NFR-1: Response Time
- Quiz assembly creation: < 2 seconds for assemblies with up to 50 questions
- Quiz assembly retrieval: < 500ms for any size assembly
- Question validation: < 1 second for up to 100 questions

#### NFR-2: Throughput
- Support 100 concurrent quiz assembly operations
- Handle 500 assembly retrievals per minute
- Maintain performance with assemblies containing up to 100 questions

#### NFR-3: Scalability
- MongoDB sharding support for horizontal scaling
- Efficient indexing for large question bank collections
- Memory-efficient question snapshot creation

### 4.2 Reliability Requirements

#### NFR-4: Availability
- 99.9% uptime for quiz assembly operations
- Graceful degradation if question-bank module is temporarily unavailable
- Automated retry mechanisms for transient failures

#### NFR-5: Data Consistency
- ACID compliance for all quiz assembly operations
- Eventual consistency for cross-module operations
- Data backup and recovery capabilities

### 4.3 Security Requirements

#### NFR-6: Authentication & Authorization
- JWT token validation for all operations
- Role-based access control (course creator role required)
- Session timeout and refresh mechanisms

#### NFR-7: Data Security
- All data encrypted in transit (HTTPS)
- Sensitive data encrypted at rest
- Audit logging for all quiz assembly operations

### 4.4 Usability Requirements

#### NFR-8: API Design
- RESTful API following HTTP standards
- Consistent error response format
- Comprehensive API documentation

#### NFR-9: Error Handling
- Clear, actionable error messages
- Proper HTTP status codes
- Detailed error codes for client handling

## 5. Use Case Scenarios

### 5.1 Scenario 1: First-Time Quiz Assembly Creation

**Context**: Course creator wants to create their first quiz assembly

**Steps**:
1. User logs into course management dashboard
2. Navigates to Question Bank section
3. Reviews available questions (50 JavaScript questions)
4. Selects 10 questions covering array methods
5. Clicks "Create Quiz Assembly" button
6. Fills in quiz metadata (title: "JavaScript Arrays Quiz", description: "Basic array operations")
7. Sets assembly settings (60-minute time limit, allow review)
8. Submits creation request

**Expected Outcome**:
- Quiz assembly created with ID: `018f-a1b2-c3d4-e5f6-123456789abc`
- Total points calculated automatically (50 points)
- Question snapshots embedded in assembly
- User receives success confirmation
- Assembly appears in user's quiz list

### 5.2 Scenario 2: Update Existing Quiz Assembly

**Context**: Course creator wants to modify existing quiz assembly

**Steps**:
1. User opens existing quiz assembly for editing
2. Removes 2 questions that are too difficult
3. Adds 3 new questions about advanced array methods
4. Updates quiz metadata (description: "Comprehensive array operations")
5. Modifies assembly settings (extends time limit to 75 minutes)
6. Submits update request with same quiz_assembly_id

**Expected Outcome**:
- Existing assembly updated with new question selection
- Total points recalculated (65 points)
- Version number incremented
- Timestamps updated (updated_at field)
- User receives update confirmation

### 5.3 Scenario 3: Large Quiz Assembly Creation

**Context**: Course creator wants to create comprehensive assessment

**Steps**:
1. User selects 75 questions from multiple categories
2. Questions cover: JavaScript (25), React (25), Node.js (25)
3. Sets custom display order for logical progression
4. Configures advanced settings (randomize order, auto-submit)
5. Adds detailed quiz metadata with learning objectives

**Expected Outcome**:
- Large quiz assembly created successfully
- Questions organized by display order
- Assembly settings applied correctly
- Performance remains within acceptable limits (< 2 seconds)

## 6. Exception Scenarios

### 6.1 Exception 1: Invalid Question Selection

**Context**: User selects questions that don't exist or belong to different user

**Steps**:
1. User submits quiz assembly with invalid question IDs
2. System validates question existence
3. System discovers 3 questions don't exist

**System Response**:
- Returns HTTP 400 Bad Request
- Error message: "Questions not found: [question-id-1, question-id-2, question-id-3]"
- No partial quiz assembly created
- User can correct selection and retry

### 6.2 Exception 2: Duplicate Quiz Assembly ID

**Context**: User attempts to create assembly with existing ID

**Steps**:
1. User submits creation request with duplicate quiz_assembly_id
2. System detects existing assembly with same ID
3. User hasn't specified this as an update operation

**System Response**:
- Returns HTTP 409 Conflict
- Error message: "Quiz assembly already exists. Use PUT for updates."
- Suggests using update endpoint
- Original assembly remains unchanged

### 6.3 Exception 3: Database Connection Failure

**Context**: MongoDB becomes temporarily unavailable

**Steps**:
1. User submits valid quiz assembly creation request
2. System validates inputs successfully
3. Database connection fails during persistence

**System Response**:
- Returns HTTP 503 Service Unavailable
- Error message: "Service temporarily unavailable. Please try again."
- Implements retry mechanism with exponential backoff
- Logs error for system administrator

## 7. Data Flow Diagrams

### 7.1 Create Quiz Assembly Flow
```
[Course Creator]
    │
    │ POST /api/users/{userId}/questionbanks/{questionbankId}/quiz-assemblies
    ▼
[Quiz Assembly Controller]
    │
    │ AssembleQuizCommand
    ▼
[Mediator] ──────────────────────▶ [AssembleQuizCommandHandler]
    │                                      │
    │                                      │ validate & process
    ▼                                      ▼
[Validation Chain]                 [QuizAssemblyApplicationService]
    │                                      │
    │ validate ownership                   │ retrieve questions
    │ validate questions                   ▼
    │ validate data                [QuestionRetrievalService]
    ▼                                      │
[Validation Result]                        │ query question-bank
    │                                      ▼
    │ if success                    [Question Snapshots]
    ▼                                      │
[Continue Processing]                      │ create aggregate
                                          ▼
                                  [QuizAssemblyAggregate]
                                          │
                                          │ persist
                                          ▼
                                  [MongoQuizAssemblyRepository]
                                          │
                                          │ upsert
                                          ▼
                                  [MongoDB: quiz_assemblies]
                                          │
                                          │ return result
                                          ▼
                                  [QuizAssemblyResponseDto]
```

### 7.2 Retrieve Quiz Assembly Flow
```
[Course Creator]
    │
    │ GET /api/users/{userId}/questionbanks/{questionbankId}/quiz-assemblies/{assemblyId}
    ▼
[Quiz Assembly Controller]
    │
    │ GetQuizAssemblyByIdQuery
    ▼
[Mediator] ──────────────────────▶ [GetQuizAssemblyQueryHandler]
    │                                      │
    │                                      │ process query
    ▼                                      ▼
[Query Processing]                 [QuizAssemblyQueryService]
    │                                      │
    │ validate ownership                   │ find by ID
    ▼                                      ▼
[Ownership Validation]             [MongoQuizAssemblyRepository]
    │                                      │
    │ if authorized                        │ query
    ▼                                      ▼
[Continue Query]                   [MongoDB: quiz_assemblies]
                                          │
                                          │ return document
                                          ▼
                                  [QuizAssemblyAggregate]
                                          │
                                          │ map to DTO
                                          ▼
                                  [QuizAssemblyResponseDto]
```

## 8. Integration Points

### 8.1 Cross-Module Dependencies

#### Integration with question-bank Module
- **Dependency**: QuestionRepository for question data retrieval
- **Interface**: QuestionRetrievalService
- **Data Flow**: quiz-assembly → question-bank (read-only)
- **Error Handling**: Graceful degradation if question-bank unavailable

#### Integration with global-shared-library
- **Dependency**: Mediator pattern for CQRS
- **Interface**: IMediator, ICommand, IQuery
- **Data Flow**: Bidirectional command/query routing
- **Error Handling**: Result<T> wrapper for consistent error handling

### 8.2 External System Dependencies

#### MongoDB Integration
- **Collections**: quiz_assemblies (primary), questions (read-only)
- **Operations**: Insert, Update, Query, Upsert
- **Indexing**: Compound indexes for efficient querying
- **Transactions**: ACID compliance for data consistency

#### Spring Boot Integration
- **Annotations**: @Service, @Repository, @Controller
- **Dependency Injection**: Constructor injection pattern
- **Transaction Management**: @Transactional for data operations
- **Security**: Spring Security for authentication/authorization

## 9. Error Handling Strategy

### 9.1 Error Categories

#### Validation Errors (HTTP 400)
- Invalid UUID format for IDs
- Missing required fields in request
- Invalid question selections
- Data constraint violations

#### Authorization Errors (HTTP 403)
- User doesn't own question bank
- User doesn't own quiz assembly
- Insufficient permissions for operation

#### Not Found Errors (HTTP 404)
- Question bank doesn't exist
- Quiz assembly doesn't exist
- Selected questions not found

#### Conflict Errors (HTTP 409)
- Duplicate quiz assembly ID
- Version conflicts during updates

#### Server Errors (HTTP 500)
- Database connection failures
- Unexpected system errors
- Cross-module communication failures

### 9.2 Error Response Format
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Selected questions not found",
    "details": {
      "invalid_question_ids": [
        "018f-1111-2222-3333-444444444444",
        "018f-5555-6666-7777-888888888888"
      ],
      "field": "selected_question_ids",
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

## 10. Testing Strategy

### 10.1 Unit Testing
- Domain aggregate business logic
- Validation chain components
- Command and query handlers
- Repository operations (with mocks)

### 10.2 Integration Testing
- Cross-module communication
- Database operations with TestContainers
- API endpoint testing
- Transaction management

### 10.3 End-to-End Testing
- Complete user workflows
- Error scenario handling
- Performance testing with large assemblies
- Concurrent user operations

This comprehensive use case design provides a solid foundation for implementing the quiz assembly feature while maintaining consistency with existing system architecture and ensuring robust, scalable operations.