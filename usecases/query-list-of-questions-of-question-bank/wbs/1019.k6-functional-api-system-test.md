# User Story 1019: K6 Functional API System Test (Real MongoDB Replica Set)

## Goal
Functional API system tests using K6 against a running Spring Boot app connected to a real MongoDB replica set, validating business flows and response structure using existing seeded data.

## Environment
- Spring profile: `dev` (bypasses SecurityContextValidator)
- Real MongoDB replica set: connection configured in `orchestration-layer/src/main/resources/application-dev.properties`
- Base URL: `http://localhost:8765`
- Test data (must exist in the replica set):
  - TEST_USER_ID = 1760085803933
  - TEST_QUESTION_BANK_ID = 1760085804015000

## Start/Stop Spring Boot for K6

### 1.1 Kill previous stale Spring Boot
```bash
ps aux | grep "[O]rchestrationLayerApplication" | awk '{print $2}' | xargs -r kill -9
```

### 1.2 Rebuild dependencies
```bash
mvn clean compile
```

### 1.3 Start Spring Boot with dev profile
```bash
mvn spring-boot:run -pl orchestration-layer -Dspring-boot.run.profiles=dev
```

Notes:
- `application-dev.properties` sets the replica set URI, read preference, and disables the security context validator for development.
- Ensure the replica set and credentials are reachable from localhost.

## K6 Test Config
```javascript
const BASE_URL = 'http://localhost:8765';
const TEST_USER_ID = 1760085803933;
const TEST_QUESTION_BANK_ID = 1760085804015000;
```

## Test Artifacts to Reuse
- Functional flow reference: `api-system-test/test-upsert-question-with-taxonomy.js` (structure, checks, and HTML report generation)

## Scenarios (Functional)
- Basic query returns 200 and well-formed JSON with questions + pagination
- Category filter returns subset containing category
- Text search returns results containing all AND terms (builder enforces AND semantics)
- Combined filters (categories + tags + searchText) return consistent subset
- Sorting and pagination parameters accepted and honored

## Suggested K6 Script (functional)
Create `api-system-test/test-query-questions-functional.js` (or adapt an existing file) with light load and rich checks.

- Virtual users: constant 5-10
- Duration: 1-2 minutes
- Thresholds: http_req_failed < 1%, http_req_duration p(95) < 800ms (functional, not strict perf)
- Reuse HTML report generation from the reference file.

Example options:
```javascript
export const options = {
  vus: 5,
  duration: '2m',
  thresholds: {
    http_req_failed: ['rate<0.01'],
    http_req_duration: ['p(95)<800'],
  },
};
```

## How to Run
- Terminal 1: start Spring Boot with dev profile (see steps above)
- Terminal 2: execute K6 functional suite

```bash
k6 run \
  -e BASE_URL=http://localhost:8765 \
  -e USER_ID=1760085803933 \
  -e QUESTION_BANK_ID=1760085804015000 \
  api-system-test/test-query-questions-functional.js
```

Optionally set `K6_SCRIPT_PATH` env for report naming:
```bash
k6 run -e K6_SCRIPT_PATH=api-system-test/test-query-questions-functional.js api-system-test/test-query-questions-functional.js
```

## Reporting
- Generate HTML and JSON reports using the same reporter used in `test-upsert-question-with-taxonomy.js`.
- Reports path suggestion:
```
api-system-test/reports/test-query-questions-functional/
  ├── summary-report.html
  └── summary-data.json
```

## Acceptance Criteria
- [ ] Spring Boot starts with `dev` profile and connects to the real replica set
- [ ] Functional K6 suite executes successfully with status 200 across scenarios
- [ ] Response structure validated (questions + pagination)
- [ ] Reports generated (HTML + JSON)
- [ ] Documentation here is sufficient to run locally

## References
- Real MongoDB replica set URI: `orchestration-layer/src/main/resources/application-dev.properties`
- Existing k6 functional example: `api-system-test/test-upsert-question-with-taxonomy.js`
- k6 docs: https://k6.io/docs/
