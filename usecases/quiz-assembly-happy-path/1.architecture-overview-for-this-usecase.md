# Architecture Overview - Quiz Assembly Use Case

## System Context

### Multi-Module Maven Architecture
```
quiz-cms (Parent)
├── orchestration-layer (Spring Boot App - Port 8080)
│   ├── Controllers (HTTP Layer)
│   ├── Command Handlers (CQRS)
│   └── Application Services (Orchestration)
├── internal-layer (Business Logic)
│   ├── quiz-assembly (NEW Bounded Context)
│   │   ├── Domain (Aggregates, Entities)
│   │   ├── Application (Ports/Services)
│   │   └── Infrastructure (Repositories)
│   ├── question-bank (Existing Bounded Context)
│   │   ├── Domain (Question Management)
│   │   ├── Application (Question Services)
│   │   └── Infrastructure (Question Repositories)
│   └── shared (Cross-Module)
│       ├── AggregateRoot.java
│       └── TestDataLoader
├── global-shared-library (Infrastructure)
│   ├── Mediator Pattern (CQRS)
│   ├── Result<T> (Response Wrapper)
│   └── Common Utilities
└── external-service-proxy (External Integration)
    └── [Not used in this use case]
```

## Architectural Patterns Applied

### 1. Domain-Driven Design (DDD)
- **Bounded Context**: quiz-assembly module encapsulates quiz aggregation domain
- **Aggregates**: QuizAssemblyAggregate, AssembledQuestion (Value Object)
- **Domain Events**: Stored in AggregateRoot for eventual consistency
- **Repositories**: Abstract data access with domain-focused interfaces

### 2. CQRS (Command Query Responsibility Segregation)
- **Commands**: AssembleQuizCommand for write operations, GetQuizAssemblyQuery for read operations
- **Queries**: GetQuizAssemblyByIdQuery for retrieval operations
- **Mediator**: Routes commands and queries to appropriate handlers
- **Handlers**: Single responsibility for each use case

### 3. Hexagonal Architecture (Ports & Adapters)
```
┌─────────────────────────────────────────────────────────────┐
│                    orchestration-layer                      │
│  ┌─────────────────┐    ┌──────────────────────────────────┐ │
│  │   Controller    │───▶│     Command Handler              │ │
│  │  (HTTP Adapter) │    │   (Application Service)         │ │
│  └─────────────────┘    └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                  │
                                  ▼ (via Mediator)
┌─────────────────────────────────────────────────────────────┐
│                internal-layer/quiz-assembly                 │
│  ┌─────────────────┐    ┌──────────────────────────────────┐ │
│  │  Application    │───▶│           Domain                 │ │
│  │   Service       │    │   (QuizAssemblyAggregate)       │ │
│  │   (Port IN)     │    │                                  │ │
│  └─────────────────┘    └──────────────────────────────────┘ │
│           │                              │                   │
│           ▼                              ▼                   │
│  ┌─────────────────┐    ┌──────────────────────────────────┐ │
│  │  Infrastructure │    │        Repositories              │ │
│  │    (Adapters)   │    │       (Port OUT)                │ │
│  └─────────────────┘    └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────┐
│               Cross-Module Integration                      │
│  ┌─────────────────┬──────────────────┬─────────────────────┐ │
│  │ QuestionRetrieval│ MongoDB Adapter │ Question-Bank       │ │
│  │    Service       │     (quiz_      │   Integration       │ │
│  │                  │   assemblies)   │                     │ │
│  └─────────────────┴──────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4. Design Patterns Implementation

#### Chain of Responsibility (Validation)
```java
public abstract class ValidationHandler {
    protected ValidationHandler next;

    public ValidationHandler setNext(ValidationHandler handler) {
        this.next = handler;
        return handler;
    }

    public abstract Result<Void> validate(AssembleQuizCommand command);
}

// Concrete Validators
- QuestionBankOwnershipValidator
- SelectedQuestionsValidator
- QuizAssemblyDataValidator
- DuplicateAssemblyIdValidator
```

#### Repository Pattern (Data Access)
```java
// Port OUT interfaces
public interface QuizAssemblyRepository {
    Result<QuizAssemblyAggregate> upsertByAssemblyId(QuizAssemblyAggregate aggregate);
    Result<QuizAssemblyAggregate> findByAssemblyId(String assemblyId);
}

// Infrastructure implementations
public class MongoQuizAssemblyRepository implements QuizAssemblyRepository {
    // MongoDB-specific implementation with quiz_assemblies collection
}
```

#### Strategy Pattern (Cross-Module Integration)
```java
public interface QuestionRetrievalStrategy {
    Result<List<QuestionSnapshot>> retrieveQuestions(
        Long userId, String questionBankId, List<String> questionIds
    );
}

// Concrete Strategies
- DirectQuestionBankStrategy (current implementation)
- CachedQuestionRetrievalStrategy (future enhancement)
```

## Data Flow Architecture

### Request Processing Flow - POST (Create Quiz Assembly)
```
HTTP Request
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  orchestration-layer                                        │
│  ┌─────────────────┐                                        │
│  │   Controller    │ 1. Extract userId, questionBankId     │
│  │                 │    from path parameters               │
│  │                 │ 2. Create AssembleQuizCommand         │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │    Mediator     │ 3. Route to AssembleQuizHandler       │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │  Command        │ 4. Orchestrate validation and         │
│  │  Handler        │    business logic execution           │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
           │
           ▼ (Inject Application Service)
┌─────────────────────────────────────────────────────────────┐
│  internal-layer/quiz-assembly                               │
│  ┌─────────────────┐                                        │
│  │  Application    │ 5. Execute validation chain           │
│  │  Service        │ 6. Retrieve questions from            │
│  │  (Port IN)      │    question-bank module               │
│  │                 │ 7. Instantiate domain aggregates      │
│  │                 │ 8. Coordinate repository operations   │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │   Validation    │ 9. Chain of Responsibility:           │
│  │     Chain       │    - Ownership validation             │
│  │                 │    - Question existence validation    │
│  │                 │    - Data integrity validation        │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │ Cross-Module    │ 10. Retrieve questions via            │
│  │ Integration     │     QuestionRetrievalService          │
│  │ Service         │ 11. Create question snapshots         │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │    Domain       │ 12. Instantiate QuizAssemblyAggregate │
│  │  Aggregates     │ 13. Apply business rules              │
│  │                 │ 14. Generate domain events            │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │  Repositories   │ 15. Transactional upsert operation:   │
│  │   (Port OUT)    │     - Insert or update quiz assembly  │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│  MongoDB Collections                                        │
│  ┌─────────────────┬──────────────────┬─────────────────────┐ │
│  │ quiz_assemblies │    questions     │ question_taxonomy   │ │
│  │   (upsert)      │   (read-only)    │ _relationships      │ │
│  │                 │                  │   (read-only)       │ │
│  └─────────────────┴──────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Request Processing Flow - GET (Retrieve Quiz Assembly)
```
HTTP Request
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  orchestration-layer                                        │
│  ┌─────────────────┐                                        │
│  │   Controller    │ 1. Extract userId, questionBankId,    │
│  │                 │    quizAssemblyId from path           │
│  │                 │ 2. Create GetQuizAssemblyQuery        │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │    Mediator     │ 3. Route to GetQuizAssemblyHandler    │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │  Query          │ 4. Execute query processing           │
│  │  Handler        │                                        │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
           │
           ▼ (Inject Query Service)
┌─────────────────────────────────────────────────────────────┐
│  internal-layer/quiz-assembly                               │
│  ┌─────────────────┐                                        │
│  │  Query          │ 5. Validate ownership                 │
│  │  Service        │ 6. Retrieve quiz assembly             │
│  │  (Port IN)      │ 7. Map to response DTO                │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │  Repositories   │ 8. Query quiz_assemblies collection   │
│  │   (Port OUT)    │ 9. Apply user/bank filters            │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│  MongoDB Collection: quiz_assemblies                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ Query: { user_id, question_bank_id, quiz_assembly_id } │ │
│  │ Index: Compound index for efficient lookup             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Component Interaction Details

### 1. Controller Layer (orchestration-layer)
```java
@RestController
@RequestMapping("/api/users/{userId}/questionbanks/{questionbankId}/quiz-assemblies")
public class QuizAssemblyController {

    private final IMediator mediator;

    @PostMapping
    public ResponseEntity<Result<QuizAssemblyResponseDto>> assembleQuiz(
        @PathVariable Long userId,
        @PathVariable String questionbankId,
        @RequestBody AssembleQuizRequestDto request) {

        var command = new AssembleQuizCommand(userId, questionbankId, request);
        var result = mediator.send(command);
        return ResponseEntity.ok(result);
    }

    @GetMapping("/{quizAssemblyId}")
    public ResponseEntity<Result<QuizAssemblyResponseDto>> getQuizAssembly(
        @PathVariable Long userId,
        @PathVariable String questionbankId,
        @PathVariable String quizAssemblyId) {

        var query = new GetQuizAssemblyByIdQuery(userId, questionbankId, quizAssemblyId);
        var result = mediator.send(query);
        return ResponseEntity.ok(result);
    }
}
```

### 2. Command Handler (orchestration-layer)
```java
@Service
public class AssembleQuizCommandHandler
    implements ICommandHandler<AssembleQuizCommand, QuizAssemblyResponseDto> {

    private static final Logger logger = LoggerFactory.getLogger(AssembleQuizCommandHandler.class);
    private final QuizAssemblyApplicationService quizAssemblyService;

    public AssembleQuizCommandHandler(QuizAssemblyApplicationService quizAssemblyService) {
        this.quizAssemblyService = quizAssemblyService;
        logger.info("AssembleQuizCommandHandler initialized with QuizAssemblyApplicationService");
    }

    @Override
    public Result<QuizAssemblyResponseDto> handle(AssembleQuizCommand command) {
        logger.info("Handling AssembleQuizCommand for quiz assembly ID: {} by user: {} in question bank: {}",
                   command.getQuizAssemblyId(), command.getUserId(), command.getQuestionBankId());

        try {
            var result = quizAssemblyService.assembleQuiz(command);

            if (result.isSuccess()) {
                logger.info("Successfully handled AssembleQuizCommand for quiz assembly ID: {}",
                           command.getQuizAssemblyId());
            } else {
                logger.warn("Failed to handle AssembleQuizCommand for quiz assembly ID: {} with error: {}",
                           command.getQuizAssemblyId(), result.getError());
            }

            return result;
        } catch (Exception ex) {
            logger.error("Unexpected error while handling AssembleQuizCommand for quiz assembly ID: {}",
                        command.getQuizAssemblyId(), ex);
            return Result.failure("COMMAND_HANDLER_ERROR: " + ex.getMessage());
        }
    }
}
```

### 3. Query Handler (orchestration-layer)
```java
@Service
public class GetQuizAssemblyQueryHandler
    implements IQueryHandler<GetQuizAssemblyByIdQuery, QuizAssemblyResponseDto> {

    private final QuizAssemblyQueryService quizAssemblyQueryService;

    @Override
    public Result<QuizAssemblyResponseDto> handle(GetQuizAssemblyByIdQuery query) {
        return quizAssemblyQueryService.getQuizAssemblyById(query);
    }
}
```

### 4. Application Service (internal-layer/quiz-assembly)
```java
@Service
@Transactional
public class QuizAssemblyApplicationService {

    private final ValidationHandler validationChain;
    private final QuestionRetrievalService questionRetrievalService;
    private final QuizAssemblyRepository quizAssemblyRepository;

    public Result<QuizAssemblyResponseDto> assembleQuiz(AssembleQuizCommand command) {
        // 1. Validate using Chain of Responsibility
        var validationResult = validationChain.validate(command);
        if (validationResult.isFailure()) {
            return Result.failure(validationResult.getError());
        }

        // 2. Retrieve questions from question-bank module
        var questionsResult = questionRetrievalService
            .retrieveQuestions(command.userId(), command.questionBankId(),
                             command.selectedQuestionIds());
        if (questionsResult.isFailure()) {
            return Result.failure(questionsResult.getError());
        }

        // 3. Create quiz assembly aggregate
        var quizAssembly = createQuizAssemblyAggregate(command, questionsResult.getValue());

        // 4. Upsert to repository (transactional)
        var result = quizAssemblyRepository.upsertByAssemblyId(quizAssembly);
        if (result.isFailure()) {
            return Result.failure(result.getError());
        }

        return Result.success(mapToResponseDto(result.getValue()));
    }
}
```

## Cross-Module Integration Strategy

### 1. Question Retrieval from question-bank Module
```java
@Service
public class QuestionRetrievalService {

    private final QuestionRepository questionRepository; // From question-bank module

    public Result<List<QuestionSnapshot>> retrieveQuestions(
        Long userId,
        String questionBankId,
        List<String> sourceQuestionIds
    ) {
        // 1. Query questions collection with multi-ID lookup
        var questions = questionRepository.findBySourceQuestionIds(
            userId, questionBankId, sourceQuestionIds
        );

        // 2. Validate all questions found
        if (questions.size() != sourceQuestionIds.size()) {
            return Result.failure("Some questions not found");
        }

        // 3. Create immutable snapshots
        var snapshots = questions.stream()
            .map(this::createQuestionSnapshot)
            .toList();

        return Result.success(snapshots);
    }
}
```

### 2. Component Scanning Configuration
The orchestration layer is configured with cross-module component scanning:
```java
@SpringBootApplication(scanBasePackages = {
    "com.quizfun.orchestrationlayer",
    "com.quizfun.internallayer",
    "com.quizfun.internallayer.quizassembly",  // NEW package for quiz-assembly
    "com.quizfun.questionbank",  // Existing question-bank
    "com.quizfun.globalshared"
})
```

## Transaction and Consistency Management

### ACID Compliance
```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public Result<QuizAssemblyResponseDto> assembleQuiz(AssembleQuizCommand command) {
    try {
        // All operations within single transaction
        var questionsResult = questionRetrievalService.retrieveQuestions(...);
        var quizAssemblyResult = quizAssemblyRepository.upsertByAssemblyId(...);
        return Result.success(quizAssemblyResult);
    } catch (Exception ex) {
        // Transaction rollback automatic
        return Result.failure("Quiz assembly operation failed");
    }
}
```

### Event Sourcing (Future Enhancement)
```java
public abstract class AggregateRoot {
    private final List<DomainEvent> domainEvents = new ArrayList<>();

    protected void addDomainEvent(DomainEvent event) {
        domainEvents.add(event);
    }

    // Events: QuizAssemblyCreated, QuizAssemblyUpdated, QuestionAddedToAssembly
}
```

## Cross-Cutting Concerns

### 1. Error Handling Strategy
- **Fast Fail**: Stop on first validation error
- **Detailed Messages**: Include field-level error information
- **Error Codes**: Enumerated error types for client handling
- **Logging**: Structured logging for debugging and monitoring

### 2. Security (Multi-Tenant)
- **Authentication**: Spring Security integration
- **Authorization**: User can only access their own quiz assemblies
- **Data Isolation**: Multi-tenant data separation by user_id and question_bank_id

### 3. Performance Considerations
- **MongoDB Indexing**: Optimized compound indexes for quiz assembly queries
- **Question Snapshot Strategy**: Embedded question data to avoid N+1 queries
- **Bulk Operations**: Efficient upsert operations for large quiz assemblies
- **Connection Pooling**: Efficient database connections

## Technology Stack Integration

### Core Technologies
- **Java 21**: Latest LTS with performance improvements
- **Spring Boot 3.5.6**: Modern Spring stack
- **MongoDB 8.0**: Document database for flexible quiz assembly schemas
- **Maven**: Multi-module project management

### Testing Technologies
- **JUnit 5**: Modern testing framework
- **TestContainers**: Integration testing with real MongoDB
- **JaCoCo**: Code coverage analysis (70% minimum)
- **Allure**: Rich test reporting

This architecture provides a scalable, maintainable foundation for the quiz assembly system while adhering to modern software engineering principles and maintaining consistency with the existing question-bank implementation.