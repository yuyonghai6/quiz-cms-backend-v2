# Architecture Overview - Upsert Question Unhappy Path Use Case

## System Context

This document outlines the architecture for handling critical unhappy paths in the upsert-question-with-taxonomies use case, building upon the existing happy path implementation (US-003 through US-007). It specifically focuses on:

1. **Security Breach Risk: Unauthorized Access to Question Banks**
2. **Type-Specific Validation Error Messages for Enhanced User Experience**

### Integration with Existing Happy Path Architecture

Building upon the completed user stories:
- **US-003**: Validation Chain Implementation (Enhanced with security validators)
- **US-004**: Question Type Strategy Implementation (Enhanced with detailed error messages)
- **US-005**: Repository Layer Implementation (Enhanced with audit logging)
- **US-007**: Application Service Integration (Enhanced with security context)

```
quiz-cms (Parent)
├── orchestration-layer (Spring Boot App - Port 8080)
│   ├── Controllers (HTTP Layer + Enhanced Security)
│   ├── Command Handlers (CQRS + Security Auditing)
│   └── Application Services (Orchestration + Error Context)
├── internal-layer (Business Logic)
│   ├── question-bank (Bounded Context)
│   │   ├── Domain (Aggregates, Entities)
│   │   ├── Application (Ports/Services + Enhanced Validators)
│   │   │   ├── Existing: QuestionApplicationService (US-007)
│   │   │   ├── Enhanced: SecurityAwareValidationChain (US-003+)
│   │   │   └── Enhanced: UserFriendlyErrorBuilder (US-004+)
│   │   └── Infrastructure (Repositories + Audit Logging)
│   │       ├── Existing: MongoQuestionRepository (US-005)
│   │       └── Enhanced: AuditLoggingRepositoryWrapper
│   └── shared (Cross-Module + Security Framework)
│       ├── AggregateRoot.java (US-005)
│       ├── ValidationHandler (US-003) - Base for security validators
│       ├── Result<T> (US-003) - Enhanced with security context
│       └── TestDataLoader (US-005)
├── global-shared-library (Infrastructure)
│   ├── Mediator Pattern (CQRS) - Existing
│   ├── Result<T> (Response Wrapper) - Enhanced for security
│   ├── RetryHelper (US-003) - Used for security operations
│   └── ValidationChainMetrics (US-003) - Enhanced for security metrics
└── external-service-proxy (External Integration)
    └── [Future: Security Monitoring Integration]
```

## Enhanced Security Architecture

### 1. Multi-Layer Security Validation

The unhappy path architecture implements defense-in-depth security validation:

```
┌─────────────────────────────────────────────────────────────┐
│                    HTTP Request                             │
│    ┌─────────────────┐                                      │
│    │   Controller    │ 1. Initial Path Parameter Validation│
│    │  (HTTP Layer)   │ 2. Authentication Context Check     │
│    │                 │ 3. Rate Limiting Enforcement        │
│    └─────────────────┘                                      │
│           │                                                 │
│           ▼                                                 │
│    ┌─────────────────┐                                      │
│    │   Enhanced      │ 4. Cross-Reference Auth Context     │
│    │   Security      │ 5. Deep Ownership Validation        │
│    │   Validator     │ 6. Suspicious Activity Detection    │
│    └─────────────────┘                                      │
│           │                                                 │
│           ▼                                                 │
│    ┌─────────────────┐                                      │
│    │   Security      │ 7. Real-time Event Publishing       │
│    │   Audit Logger  │ 8. Alert Generation                 │
│    │                 │ 9. Compliance Logging               │
│    └─────────────────┘                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Security Monitoring System                     │
│  ┌─────────────────┬──────────────────┬─────────────────────┐ │
│  │   Real-time     │   Threat         │    Compliance       │ │
│  │   Alerts        │   Detection      │    Audit Trail      │ │
│  └─────────────────┴──────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. Enhanced Validation Chain Building on US-003

Extending the existing validation chain from US-003 with security-focused validators:

```java
// Building upon existing US-003 ValidationHandler base class
public abstract class SecurityEnhancedValidator extends ValidationHandler {
    protected final SecurityAuditLogger auditLogger;
    protected final RetryHelper retryHelper; // Reuse from US-003
    protected final ValidationChainMetrics metrics; // Reuse from US-003

    public SecurityEnhancedValidator(ValidationHandler next) {
        super(next);
    }
}

// Enhanced Chain Configuration (builds on US-003 existing chain)
ValidationHandler chain =
  new SecurityContextValidator(              // NEW - Priority 1
    new EnhancedQuestionBankOwnershipValidator(  // ENHANCED from US-003
      new TaxonomyReferenceValidator(             // EXISTING from US-003
        new EnhancedQuestionDataIntegrityValidator(  // ENHANCED from US-003
          null))));

// Integration with existing US-003 chain:
- SecurityContextValidator (NEW)
  ├── JWT Token vs Path Parameter Cross-Reference
  ├── Session Security Validation
  ├── Rate Limiting (using existing RetryHelper pattern)
  └── Suspicious Activity Pattern Detection
- EnhancedQuestionBankOwnershipValidator (ENHANCED from US-003)
  ├── Existing: Basic ownership validation
  ├── NEW: Deep ownership cross-reference
  ├── NEW: Authorization audit logging
  └── NEW: Access pattern analysis
- TaxonomyReferenceValidator (EXISTING from US-003)
- EnhancedQuestionDataIntegrityValidator (ENHANCED from US-003)
  ├── Existing: Basic data integrity checks
  ├── NEW: Type-specific error messages (integrates with US-004)
  ├── NEW: User-friendly guidance
  └── NEW: Actionable error context
```

## Error Message Architecture

### 1. Type-Specific Validation Error Framework

```
┌─────────────────────────────────────────────────────────────┐
│      Enhanced Question Type Strategy Processing (US-004+)   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │          McqQuestionStrategy (Enhanced)                 │ │
│  │  ┌─────────────────┐    ┌──────────────────────────────┐ │ │
│  │  │   Existing      │───▶│     NEW: Enhanced Error      │ │ │
│  │  │   Validation    │    │     Message Builder          │ │ │
│  │  │   (US-004)      │    │     (Uses ValidationErrorCode│ │ │
│  │  └─────────────────┘    │      from US-003)           │ │ │
│  │                         └──────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │         EssayQuestionStrategy (Enhanced)               │ │
│  │  ┌─────────────────┐    ┌──────────────────────────────┐ │ │
│  │  │   Existing      │───▶│     NEW: Enhanced Error      │ │ │
│  │  │   Validation    │    │     Message Builder          │ │ │
│  │  │   (US-004)      │    │     (Integrates with Result<T>│ │ │
│  │  └─────────────────┘    │      pattern from US-003)   │ │ │
│  │                         └──────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │       TrueFalseQuestionStrategy (Enhanced)             │ │
│  │  ┌─────────────────┐    ┌──────────────────────────────┐ │ │
│  │  │   Existing      │───▶│     NEW: Enhanced Error      │ │ │
│  │  │   Validation    │    │     Message Builder          │ │ │
│  │  │   (US-004)      │    │     (Follows existing error  │ │ │
│  │  └─────────────────┘    │      handling patterns)     │ │ │
│  │                         └──────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│     Enhanced Error Response (maintains Result<T> pattern)   │
│  ┌─────────────────┬──────────────────┬─────────────────────┐ │
│  │   Clear Title   │   Actionable     │    Documentation    │ │
│  │   & Message     │   Suggestions    │    Links            │ │
│  │   (Uses existing│   (Context-aware │    (Project-specific│ │
│  │    error codes) │    guidance)     │     documentation)  │ │
│  └─────────────────┴──────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. Enhanced Error Response Structure (Building on US-003 Result<T>)

```java
// Extends existing Result<T> from US-003 rather than creating new hierarchy
public class UserFriendlyErrorResponseBuilder {

    private final ValidationErrorCode existingErrorCode; // From US-003
    private final MessageSource messageSource; // For internationalization
    private final DocumentationUrlService docService; // Project-specific docs

    // Convert existing Result<T> failure to user-friendly format
    public Result<T> enhanceWithUserGuidance(Result<T> originalResult, ValidationContext context) {
        if (originalResult.isSuccess()) {
            return originalResult; // No enhancement needed
        }

        // Build enhanced error message using existing error codes
        String enhancedMessage = buildContextualMessage(
            originalResult.getError(),
            context
        );

        // Maintain existing Result<T> pattern, just enhance the message
        return Result.failure(enhancedMessage, originalResult.getErrorCode());
    }

    private String buildContextualMessage(String originalError, ValidationContext context) {
        return MessageFormat.format(
            "{0}\n\nSuggestions:\n{1}\n\nDocumentation: {2}",
            originalError,
            String.join("\n", buildSuggestions(context)),
            docService.getRelevantUrl(context.getValidationErrorCode())
        );
    }
}
```

## Security Event Architecture

### 1. Security Event Publishing Pipeline

```
┌─────────────────────────────────────────────────────────────┐
│                  Security Event Detection                   │
│           ┌─────────────────────────────────────┐           │
│           │        Security Validator           │           │
│           └─────────────────────────────────────┘           │
│                            │                                │
│                            ▼                                │
│           ┌─────────────────────────────────────┐           │
│           │      Security Event Builder        │           │
│           │  - Event Type Classification       │           │
│           │  - Severity Assessment            │           │
│           │  - Context Enrichment            │           │
│           └─────────────────────────────────────┘           │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Security Event Publisher                   │ │
│  │  ┌─────────────────┐    ┌──────────────────────────────┐ │ │
│  │  │   Async Event   │    │     Synchronous              │ │ │
│  │  │   Publishing    │    │     Alert System            │ │ │
│  │  └─────────────────┘    └──────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              External Security Systems                      │
│  ┌─────────────────┬──────────────────┬─────────────────────┐ │
│  │    SIEM         │   Alerting       │     Compliance      │ │
│  │    System       │   Service        │     Logging         │ │
│  └─────────────────┴──────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. Security Event Types and Classifications

```java
public enum SecurityEventType {
    // Authorization Violations
    UNAUTHORIZED_ACCESS_ATTEMPT(SeverityLevel.HIGH),
    PATH_PARAMETER_MANIPULATION(SeverityLevel.HIGH),
    TOKEN_PRIVILEGE_ESCALATION(SeverityLevel.CRITICAL),

    // Suspicious Activity
    RATE_LIMIT_EXCEEDED(SeverityLevel.MEDIUM),
    UNUSUAL_ACCESS_PATTERN(SeverityLevel.MEDIUM),
    REPEATED_AUTHORIZATION_FAILURES(SeverityLevel.HIGH),

    // Session Security
    SESSION_HIJACKING_ATTEMPT(SeverityLevel.CRITICAL),
    INVALID_SESSION_TOKEN(SeverityLevel.HIGH),
    CONCURRENT_SESSION_VIOLATION(SeverityLevel.MEDIUM);
}
```

## Data Flow for Unhappy Paths

### 1. Security Breach Detection Flow

```
HTTP Request (Potentially Malicious)
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  orchestration-layer                                        │
│  ┌─────────────────┐                                        │
│  │   Controller    │ 1. Extract and validate path params   │
│  │                 │ 2. Check authentication context       │
│  │                 │ 3. Apply rate limiting                │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼ (Suspicious Activity Detected)                  │
│  ┌─────────────────┐                                        │
│  │   Enhanced      │ 4. Cross-reference user context       │
│  │   Security      │ 5. Deep ownership validation         │
│  │   Validator     │ 6. Pattern analysis                  │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼ (Security Violation Confirmed)                  │
│  ┌─────────────────┐                                        │
│  │   Security      │ 7. Log security event                │
│  │   Audit Logger  │ 8. Trigger immediate alerts          │
│  │                 │ 9. Apply defensive measures           │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│  Response: 403 Forbidden + Security Alert                  │
│  {                                                          │
│    "error": "UNAUTHORIZED_ACCESS",                          │
│    "message": "Access denied",                              │
│    "timestamp": "2025-09-26T10:30:00Z",                     │
│    "requestId": "req_security_violation_123"                │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

### 2. Type-Specific Validation Error Flow

```
HTTP Request (Invalid Question Data)
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  internal-layer/question-bank                               │
│  ┌─────────────────┐                                        │
│  │  Application    │ 1. Pass initial validation chain      │
│  │  Service        │ 2. Reach strategy processing          │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │   Question      │ 3. Detect type-specific validation    │
│  │   Type          │    failure (e.g., invalid MCQ data)   │
│  │   Strategy      │ 4. Generate contextual error          │
│  └─────────────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │   Error Message │ 5. Build user-friendly error          │
│  │   Builder       │ 6. Add actionable suggestions         │
│  │                 │ 7. Include documentation links        │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│  Response: 422 Unprocessable Entity + Helpful Guidance     │
│  {                                                          │
│    "error": "INVALID_MCQ_OPTIONS",                          │
│    "title": "MCQ Must Have At Least 2 Options",            │
│    "message": "Your MCQ question has 1 option(s)...",       │
│    "suggestions": ["Add more options to create..."],        │
│    "documentationUrl": "https://docs.../mcq-validation"     │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

## Integration with Existing Architecture

### 1. Enhanced CQRS Command Handling

```java
@Service
public class SecurityAwareUpsertQuestionCommandHandler
    implements ICommandHandler<UpsertQuestionCommand, QuestionResponseDto> {

    private final SecurityContextValidator securityValidator;
    private final QuestionApplicationService questionApplicationService;
    private final SecurityAuditLogger auditLogger;

    @Override
    public Result<QuestionResponseDto> handle(UpsertQuestionCommand command) {
        // Enhanced security validation before business logic
        var securityResult = securityValidator.validateSecurityContext(command);
        if (securityResult.isFailure()) {
            auditLogger.logSecurityViolation(command, securityResult);
            return Result.failure(securityResult.getError());
        }

        // Continue with existing business logic
        var result = questionApplicationService.upsertQuestion(command);

        // Audit successful operations for security analysis
        if (result.isSuccess()) {
            auditLogger.logSuccessfulOperation(command, result);
        }

        return result;
    }
}
```

### 2. Enhanced Repository Layer with Audit Trails

```java
@Repository
public class SecurityAwareMongoQuestionRepository implements QuestionRepository {

    private final MongoTemplate mongoTemplate;
    private final SecurityAuditLogger auditLogger;

    @Override
    public Result<QuestionAggregate> upsertBySourceQuestionId(QuestionAggregate aggregate) {
        try {
            // Log data access for security monitoring
            auditLogger.logDataAccess(aggregate.getUserId(), aggregate.getQuestionBankId(), "UPSERT");

            // Existing upsert logic with enhanced error context
            var result = performUpsert(aggregate);

            if (result.isSuccess()) {
                auditLogger.logDataModification(aggregate, "UPSERT_SUCCESS");
            }

            return result;

        } catch (Exception ex) {
            auditLogger.logDataAccessFailure(aggregate, ex);
            return Result.failure("Database operation failed", ex);
        }
    }
}
```

## Technology Stack Integration

### Core Technologies for Unhappy Path Handling
- **Java 21**: Enhanced pattern matching for security event classification
- **Spring Boot 3.5.6**: Spring Security integration for enhanced validation
- **Spring Security**: Advanced authentication and authorization mechanisms
- **MongoDB 8.0**: Audit logging and security event storage
- **Micrometer**: Security metrics and monitoring integration

### Security Technologies
- **Spring Security**: Enhanced authentication context validation
- **Rate Limiting**: Token bucket or sliding window implementations
- **JWT Validation**: Enhanced token integrity checking
- **Audit Logging**: Structured security event logging

### Error Handling Technologies
- **Jackson**: Enhanced JSON error response serialization
- **Bean Validation**: JSR-303 annotations for input validation
- **MessageSource**: Internationalized error messages
- **OpenAPI**: Enhanced error response documentation

This architecture ensures comprehensive security protection and user-friendly error handling while integrating seamlessly with the existing happy path implementation. The enhanced validation and security frameworks provide defense-in-depth protection while maintaining system performance and user experience.