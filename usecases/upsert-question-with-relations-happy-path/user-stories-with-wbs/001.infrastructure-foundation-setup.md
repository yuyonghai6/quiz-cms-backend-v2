# US-001: Infrastructure Foundation Setup

## Story Overview
**As a** developer
**I want** to establish the core infrastructure foundation with domain base classes and testing environment
**So that** I can build the question management system on a solid architectural foundation with reliable testing

## Business Value
- Enables consistent domain modeling across all aggregates
- Provides reliable testing environment with data isolation
- Establishes foundation for all subsequent development
- Ensures test reliability and repeatability

## Work Breakdown Structure (WBS)

### 1. Question-Bank Module Structure Setup
**Estimated Effort**: 0.5 days
**Priority**: High
**Dependencies**: US-000 complete

#### Tasks:
- [ ] **1.1** Create question-bank module directory structure
  ```
  internal-layer/question-bank/
  ├── src/main/java/com/quizfun/questionbank/
  │   ├── domain/
  │   │   ├── aggregates/
  │   │   ├── entities/
  │   │   ├── events/
  │   │   └── services/
  │   ├── application/
  │   │   ├── ports/
  │   │   │   ├── in/
  │   │   └── │   └── out/
  │   │   └── services/
  │   └── infrastructure/
  │       ├── persistence/
  │       └── configuration/
  └── src/test/java/
  ```
- [ ] **1.2** Configure question-bank module POM with dependencies
- [ ] **1.3** Add dependency on shared module
- [ ] **1.4** Configure Maven compiler plugin for parameters
- [ ] **1.5** Add Spring Boot starter dependencies

#### Implementation Details:
```xml
<!-- internal-layer/question-bank/pom.xml -->
<dependencies>
    <dependency>
        <groupId>com.quizfun</groupId>
        <artifactId>shared</artifactId>
        <version>${project.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-mongodb</artifactId>
    </dependency>
</dependencies>
```

#### Acceptance Criteria:
- Module structure follows hexagonal architecture
- Dependencies properly configured
- Maven build successful
- Package structure supports DDD patterns

#### TDD Cycle and Verification Approach:

**Red Phase (Write Failing Tests First):**
```java
class QuestionBankModuleStructureTest {

    @Test
    @DisplayName("Should compile question-bank module successfully")
    void shouldCompileQuestionBankModuleSuccessfully() {
        // Test will fail initially when module structure doesn't exist
        var context = new AnnotationConfigApplicationContext();
        context.scan("com.quizfun.questionbank");

        assertThat(context.getBeanDefinitionCount()).isGreaterThan(0);
        assertThat(context.getEnvironment()).isNotNull();
    }

    @Test
    @DisplayName("Should resolve shared module dependency")
    void shouldResolveSharedModuleDependency() {
        // Test access to shared module classes
        assertDoesNotThrow(() -> {
            Class.forName("com.quizfun.shared.domain.AggregateRoot");
            Class.forName("com.quizfun.shared.common.Result");
            Class.forName("com.quizfun.shared.validation.ValidationHandler");
        });
    }

    @Test
    @DisplayName("Should support hexagonal architecture package structure")
    void shouldSupportHexagonalArchitecturePackageStructure() {
        // Verify key packages exist and are accessible
        var packages = List.of(
            "com.quizfun.questionbank.domain.aggregates",
            "com.quizfun.questionbank.domain.entities",
            "com.quizfun.questionbank.domain.events",
            "com.quizfun.questionbank.application.ports.in",
            "com.quizfun.questionbank.application.ports.out",
            "com.quizfun.questionbank.application.services",
            "com.quizfun.questionbank.infrastructure.persistence",
            "com.quizfun.questionbank.infrastructure.configuration"
        );

        packages.forEach(packageName -> {
            assertDoesNotThrow(() -> {
                var package_ = Package.getPackage(packageName);
                // Package should be accessible (will be null until classes are loaded)
                assertThat(packageName).matches("com\\.quizfun\\.questionbank\\..+");
            });
        });
    }

    @Test
    @DisplayName("Should have Spring Boot dependencies configured")
    void shouldHaveSpringBootDependenciesConfigured() {
        // Test Spring Boot starter availability
        assertDoesNotThrow(() -> {
            Class.forName("org.springframework.boot.SpringApplication");
            Class.forName("org.springframework.data.mongodb.core.MongoTemplate");
            Class.forName("org.springframework.context.annotation.Configuration");
        });
    }

    @Test
    @DisplayName("Should support Maven compiler parameters")
    void shouldSupportMavenCompilerParameters() {
        // Verify that method parameter names are preserved
        var method = Arrays.stream(TestController.class.getDeclaredMethods())
            .filter(m -> m.getName().equals("testMethod"))
            .findFirst()
            .orElseThrow();

        var parameters = method.getParameters();
        assertThat(parameters).hasSize(1);

        // Parameter names should be available (requires -parameters compiler flag)
        assertThat(parameters[0].getName()).isNotEqualTo("arg0");
    }

    @RestController
    static class TestController {
        public String testMethod(@RequestParam String testParam) {
            return testParam;
        }
    }

    @Test
    @DisplayName("Should isolate test and main source directories")
    void shouldIsolateTestAndMainSourceDirectories() {
        // Verify test classes don't interfere with main classes
        var testConfig = TestContainersConfig.class;
        assertThat(testConfig.getPackage().getName()).contains("test");

        // Main package should be separate
        assertDoesNotThrow(() -> {
            Class.forName("com.quizfun.questionbank.domain.aggregates.QuestionAggregate");
        });
    }
}
```

**Green Phase (Minimal Implementation):**
- Create basic module directory structure
- Configure minimal POM with required dependencies
- Add empty package directories for hexagonal architecture
- Ensure Maven compilation succeeds

**Refactor Phase:**
- Optimize Maven configuration
- Add proper package-info.java files
- Clean up dependency versions
- Add module documentation

**Verification Criteria:**
- [ ] Maven clean compile succeeds (zero compilation errors)
- [ ] All package structures accessible from tests
- [ ] Shared module dependency resolves correctly
- [ ] Spring Boot context loads successfully
- [ ] Build time <30 seconds for clean compile

---

### 2. TestContainers MongoDB Configuration
**Estimated Effort**: 1 day
**Priority**: High
**Dependencies**: Task 1 complete

#### Tasks:
- [ ] **2.1** Add TestContainers dependencies to question-bank module
- [ ] **2.2** Create TestContainers configuration class
- [ ] **2.3** Configure MongoDB 8.0 container setup
- [ ] **2.4** Implement test database isolation
- [ ] **2.5** Create test profile configuration
- [ ] **2.6** Add MongoDB connection validation

#### Implementation Details:
```java
// Location: internal-layer/question-bank/src/test/java/com/quizfun/questionbank/config/TestContainersConfig.java
@TestConfiguration
public class TestContainersConfig {

    @Container
    static MongoDBContainer mongoContainer = new MongoDBContainer("mongo:8.0")
        .withExposedPorts(27017)
        .withReuse(false);

    @Bean
    @Primary
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        mongoContainer.start();
        registry.add("spring.data.mongodb.uri", mongoContainer::getReplicaSetUrl);
        registry.add("spring.data.mongodb.database", () -> "quiz_cms_test");
    }

    @Bean
    @Primary
    public MongoTemplate testMongoTemplate() {
        return new MongoTemplate(
            MongoClients.create(mongoContainer.getReplicaSetUrl()),
            "quiz_cms_test"
        );
    }
}
```

#### Acceptance Criteria:
- MongoDB container starts automatically for tests
- Test database isolation ensured
- Connection established and validated
- Container cleanup after tests

#### TDD Cycle and Verification Approach:

**Red Phase (Write Failing Tests First):**
```java
@Testcontainers
@SpringBootTest
@Import(TestContainersConfig.class)
class TestContainersMongoDBConfigurationTest {

    @Container
    static MongoDBContainer mongoContainer = TestContainersConfig.getMongoContainer();

    @Autowired
    private MongoTemplate mongoTemplate;

    @Test
    @DisplayName("Should start MongoDB container successfully")
    void shouldStartMongoDBContainerSuccessfully() {
        // Test will fail initially when TestContainers config doesn't exist
        assertThat(mongoContainer.isRunning()).isTrue();
        assertThat(mongoContainer.getExposedPorts()).contains(27017);
        assertThat(mongoContainer.getDockerImageName()).isEqualTo("mongo:8.0");
    }

    @Test
    @DisplayName("Should establish MongoDB connection with correct configuration")
    void shouldEstablishMongoDBConnectionWithCorrectConfiguration() {
        // Verify connection is established
        assertThat(mongoTemplate).isNotNull();

        // Test basic connectivity
        var result = mongoTemplate.execute(MongoDatabase.class, db -> {
            return db.runCommand(new Document("ping", 1));
        });

        assertThat(result.getDouble("ok")).isEqualTo(1.0);
    }

    @Test
    @DisplayName("Should use isolated test database")
    void shouldUseIsolatedTestDatabase() {
        var databaseName = mongoTemplate.getDb().getName();
        assertThat(databaseName).isEqualTo("quiz_cms_test");

        // Verify we can write to the database
        var testData = new Document("test", "isolation");
        mongoTemplate.save(testData, "test_collection");

        var retrieved = mongoTemplate.findById(testData.getObjectId("_id"), Document.class, "test_collection");
        assertThat(retrieved).isNotNull();
        assertThat(retrieved.getString("test")).isEqualTo("isolation");
    }

    @Test
    @DisplayName("Should provide database isolation between test methods")
    void shouldProvideDatabaseIsolationBetweenTestMethods() {
        // Each test should start with a clean database
        var collections = mongoTemplate.getDb().listCollectionNames().into(new ArrayList<>());

        // Save some test data
        mongoTemplate.save(new Document("isolation", "test1"), "isolation_test");

        var collectionsAfter = mongoTemplate.getDb().listCollectionNames().into(new ArrayList<>());
        assertThat(collectionsAfter.size()).isGreaterThanOrEqualTo(collections.size());
    }

    @Test
    @DisplayName("Should handle concurrent database operations")
    void shouldHandleConcurrentDatabaseOperations() throws InterruptedException {
        var results = new ConcurrentLinkedQueue<Boolean>();
        var executor = Executors.newFixedThreadPool(5);
        var latch = new CountDownLatch(20);

        for (int i = 0; i < 20; i++) {
            final int operationId = i;
            executor.submit(() -> {
                try {
                    var document = new Document("operation", operationId)
                        .append("timestamp", Instant.now());

                    mongoTemplate.save(document, "concurrent_test");

                    var retrieved = mongoTemplate.findById(
                        document.getObjectId("_id"),
                        Document.class,
                        "concurrent_test"
                    );

                    results.add(retrieved != null &&
                               retrieved.getInteger("operation").equals(operationId));
                } catch (Exception e) {
                    results.add(false);
                } finally {
                    latch.countDown();
                }
            });
        }

        latch.await(10, TimeUnit.SECONDS);
        assertThat(results).hasSize(20);
        assertThat(results.stream().allMatch(success -> success)).isTrue();
    }

    @Test
    @DisplayName("Should support MongoDB transaction operations")
    void shouldSupportMongoDBTransactionOperations() {
        // Test transaction support
        var transactionTemplate = new MongoTransactionManager(mongoTemplate.getMongoDatabaseFactory());
        var transactionManager = new TransactionTemplate(transactionTemplate);

        var result = transactionManager.execute(status -> {
            try {
                // Perform multiple operations in transaction
                mongoTemplate.save(new Document("tx", "operation1"), "tx_test");
                mongoTemplate.save(new Document("tx", "operation2"), "tx_test");

                return mongoTemplate.count(Query.query(Criteria.where("tx").exists(true)), "tx_test");
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });

        assertThat(result).isEqualTo(2L);
    }

    @Test
    @DisplayName("Should validate container cleanup and resource management")
    void shouldValidateContainerCleanupAndResourceManagement() {
        // Verify container can be stopped and cleaned up
        var initialRunning = mongoContainer.isRunning();
        assertThat(initialRunning).isTrue();

        // Test connection count doesn't grow indefinitely
        var connectionsBefore = getActiveConnectionCount();

        // Perform operations
        for (int i = 0; i < 10; i++) {
            mongoTemplate.save(new Document("cleanup", i), "cleanup_test");
        }

        var connectionsAfter = getActiveConnectionCount();

        // Connections should not grow significantly (connection pooling)
        assertThat(connectionsAfter - connectionsBefore).isLessThanOrEqualTo(5);
    }

    private int getActiveConnectionCount() {
        // MongoDB specific connection count query
        try {
            var result = mongoTemplate.execute(MongoDatabase.class, db -> {
                return db.runCommand(new Document("serverStatus", 1));
            });

            return result.getEmbedded(List.of("connections", "current"), Integer.class);
        } catch (Exception e) {
            return 0; // Fallback if command not available
        }
    }

    @AfterEach
    void cleanupAfterEachTest() {
        // Clean up test collections to ensure isolation
        var collections = mongoTemplate.getDb().listCollectionNames().into(new ArrayList<>());
        collections.stream()
            .filter(name -> name.contains("test"))
            .forEach(name -> mongoTemplate.dropCollection(name));
    }
}
```

**Green Phase (Minimal Implementation):**
- Implement basic TestContainers configuration with MongoDB 8.0
- Configure dynamic properties for connection
- Add basic MongoTemplate bean configuration
- Ensure container starts and stops properly

**Refactor Phase:**
- Optimize container startup time
- Add connection pooling configuration
- Implement database seeding utilities
- Add performance monitoring

**Verification Criteria:**
- [ ] Container startup time <30 seconds
- [ ] MongoDB connection established within 5 seconds
- [ ] Database operations complete within 100ms
- [ ] Memory usage <512MB for test containers
- [ ] Container cleanup completes within 10 seconds
- [ ] Zero connection leaks after test completion

---

### 3. Test Data Infrastructure Implementation
**Estimated Effort**: 1 day
**Priority**: High
**Dependencies**: Task 2 complete

#### Tasks:
- [ ] **3.1** Create test data directory structure
- [ ] **3.2** Implement QuestionBankTestDataLoader base class
- [ ] **3.3** Create JSON test data files
  - [ ] question-banks-per-user.json
  - [ ] taxonomy-sets.json
  - [ ] existing-questions.json
  - [ ] existing-question-taxonomy-relationships.json
- [ ] **3.4** Implement data loading methods
- [ ] **3.5** Implement cleanup functionality
- [ ] **3.6** Add per-test-class loading strategy

#### Implementation Details:
```java
// Location: internal-layer/shared/src/test/java/com/quizfun/shared/testdata/QuestionBankTestDataLoader.java
@Component
@TestConfiguration
public class QuestionBankTestDataLoader {

    private final MongoTemplate mongoTemplate;
    private final ObjectMapper objectMapper;

    public QuestionBankTestDataLoader(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
        this.objectMapper = new ObjectMapper();
        objectMapper.registerModule(new JavaTimeModule());
    }

    public void loadTestData() {
        loadQuestionBanksPerUser();
        loadTaxonomySets();
        loadExistingQuestions();
        loadExistingQuestionTaxonomyRelationships();
    }

    private void loadQuestionBanksPerUser() {
        try {
            var resource = new ClassPathResource("test-data/question-banks-per-user.json");
            var document = objectMapper.readValue(resource.getInputStream(), Document.class);
            mongoTemplate.save(document, "question_banks_per_user");
        } catch (IOException e) {
            throw new RuntimeException("Failed to load question banks test data", e);
        }
    }

    public void cleanupTestData() {
        mongoTemplate.getCollection("questions").deleteMany(new Document());
        mongoTemplate.getCollection("taxonomy_sets").deleteMany(new Document());
        mongoTemplate.getCollection("question_banks_per_user").deleteMany(new Document());
        mongoTemplate.getCollection("question_taxonomy_relationships").deleteMany(new Document());
    }
}
```

#### Test Data Files:
```
internal-layer/shared/src/test/resources/test-data/
├── question-banks-per-user.json
├── taxonomy-sets.json
├── existing-questions.json
└── existing-question-taxonomy-relationships.json
```

#### Acceptance Criteria:
- All test data files properly formatted
- Data loading works without errors
- Cleanup removes all test data
- Per-test-class isolation maintained

#### Test Requirements:
- [ ] Data loading functionality test
- [ ] Data cleanup functionality test
- [ ] Test data validation test
- [ ] Test isolation verification

---

### 4. Spring Boot Test Configuration
**Estimated Effort**: 0.5 days
**Priority**: High
**Dependencies**: Task 3 complete

#### Tasks:
- [ ] **4.1** Create base test configuration class
- [ ] **4.2** Configure test profiles (test, integration-test)
- [ ] **4.3** Setup component scanning for test packages
- [ ] **4.4** Configure MongoDB test properties
- [ ] **4.5** Add test utility classes

#### Implementation Details:
```java
// Location: internal-layer/question-bank/src/test/java/com/quizfun/questionbank/config/BaseTestConfiguration.java
@SpringBootTest
@Testcontainers
@ActiveProfiles("test")
@Import({TestContainersConfig.class, QuestionBankTestDataLoader.class})
public abstract class BaseTestConfiguration {

    @Autowired
    protected QuestionBankTestDataLoader testDataLoader;

    @Autowired
    protected MongoTemplate mongoTemplate;

    @BeforeEach
    void setupTestData() {
        testDataLoader.cleanupTestData();
        testDataLoader.loadTestData();
    }

    @AfterEach
    void cleanupTestData() {
        testDataLoader.cleanupTestData();
    }
}
```

#### Acceptance Criteria:
- Base test configuration provides common setup
- Test profiles properly configured
- Component scanning includes test packages
- Test utilities available for all tests

#### Test Requirements:
- [ ] Test configuration loading test
- [ ] Profile activation verification
- [ ] Component scanning verification

---

### 5. MongoDB Connectivity and Validation
**Estimated Effort**: 0.5 days
**Priority**: Medium
**Dependencies**: Task 4 complete

#### Tasks:
- [ ] **5.1** Implement MongoDB health check
- [ ] **5.2** Create connection validation utility
- [ ] **5.3** Add database indexing verification
- [ ] **5.4** Implement query performance baseline
- [ ] **5.5** Add connection pool configuration

#### Implementation Details:
```java
// Location: internal-layer/question-bank/src/test/java/com/quizfun/questionbank/infrastructure/MongoConnectivityTest.java
@ExtendWith(SpringExtension.class)
@Import(TestContainersConfig.class)
class MongoConnectivityTest {

    @Autowired
    private MongoTemplate mongoTemplate;

    @Test
    @DisplayName("Should establish MongoDB connection successfully")
    void shouldEstablishMongoConnection() {
        // Verify connection
        assertThat(mongoTemplate.getCollection("test")).isNotNull();

        // Verify basic operations
        var testDoc = new Document("test", "value");
        mongoTemplate.save(testDoc, "test");

        var retrieved = mongoTemplate.findAll(Document.class, "test");
        assertThat(retrieved).hasSize(1);

        // Cleanup
        mongoTemplate.remove(testDoc, "test");
    }

    @Test
    @DisplayName("Should support MongoDB transactions")
    void shouldSupportTransactions() {
        var transactionTemplate = new TransactionTemplate(
            new MongoTransactionManager(mongoTemplate.getMongoDatabaseFactory())
        );

        transactionTemplate.execute(status -> {
            var doc1 = new Document("tx_test", "value1");
            var doc2 = new Document("tx_test", "value2");

            mongoTemplate.save(doc1, "transaction_test");
            mongoTemplate.save(doc2, "transaction_test");

            return null;
        });

        var docs = mongoTemplate.findAll(Document.class, "transaction_test");
        assertThat(docs).hasSize(2);
    }
}
```

#### Acceptance Criteria:
- MongoDB connection established successfully
- Basic CRUD operations work
- Transaction support verified
- Performance baseline established

#### Test Requirements:
- [ ] Connection establishment test
- [ ] Basic CRUD operations test
- [ ] Transaction support verification test
- [ ] Performance baseline test

---

### 6. Integration Test Framework Setup
**Estimated Effort**: 0.5 days
**Priority**: Medium
**Dependencies**: Task 5 complete

#### Tasks:
- [ ] **6.1** Create integration test base class
- [ ] **6.2** Configure test data lifecycle management
- [ ] **6.3** Add test utilities for common operations
- [ ] **6.4** Implement test data builders
- [ ] **6.5** Configure Allure test reporting

#### Implementation Details:
```java
// Location: internal-layer/question-bank/src/test/java/com/quizfun/questionbank/integration/BaseIntegrationTest.java
@Epic("Question Management")
@Feature("Infrastructure Foundation")
public abstract class BaseIntegrationTest extends BaseTestConfiguration {

    @Test
    @Story("Infrastructure Foundation Setup")
    @DisplayName("Should provide working test infrastructure")
    void shouldProvideWorkingTestInfrastructure() {
        // Verify TestContainers MongoDB is running
        assertThat(mongoTemplate.getCollection("test")).isNotNull();

        // Verify test data loader is working
        testDataLoader.loadTestData();

        var questionBanks = mongoTemplate.findAll(Document.class, "question_banks_per_user");
        assertThat(questionBanks).isNotEmpty();

        // Verify cleanup works
        testDataLoader.cleanupTestData();
        questionBanks = mongoTemplate.findAll(Document.class, "question_banks_per_user");
        assertThat(questionBanks).isEmpty();
    }
}
```

#### Acceptance Criteria:
- Integration test framework fully functional
- Test data lifecycle properly managed
- Allure reporting configured
- Common test utilities available

#### Test Requirements:
- [ ] Integration test framework verification
- [ ] Test data lifecycle test
- [ ] Allure annotation functionality test

---

## Acceptance Criteria Summary

### Functional Requirements
- [ ] Question-bank module structure follows hexagonal architecture
- [ ] TestContainers MongoDB 8.0 starts and connects successfully
- [ ] Test data loading and cleanup works reliably
- [ ] Spring Boot test configuration enables all required functionality
- [ ] MongoDB connectivity and transactions verified
- [ ] Integration test framework provides solid foundation

### Non-Functional Requirements
- [ ] Test execution time <30 seconds for full suite
- [ ] Container startup time <10 seconds
- [ ] Test data loading time <5 seconds
- [ ] Memory usage <512MB during test execution
- [ ] Code coverage >85% for infrastructure components

### Definition of Done
- [ ] All infrastructure components implemented and tested
- [ ] TestContainers working with MongoDB 8.0
- [ ] Test data management functional
- [ ] Integration tests passing
- [ ] Code review completed
- [ ] Documentation updated
- [ ] CI/CD pipeline compatible

## Dependencies and Risks

### Dependencies
- US-000 (Shared Module Infrastructure) must be complete
- MongoDB TestContainers library availability
- Spring Boot test framework understanding
- Maven multi-module configuration

### Risks
- **Risk**: TestContainers resource consumption in CI/CD
  **Mitigation**: Configure container resource limits and reuse strategies

- **Risk**: Test data consistency across test runs
  **Mitigation**: Comprehensive cleanup procedures and isolation

- **Risk**: MongoDB version compatibility issues
  **Mitigation**: Pin to specific MongoDB 8.0 version in TestContainers

## Testing Strategy

### Unit Testing
- Individual component functionality
- Error handling scenarios
- Edge cases and boundary conditions

### Integration Testing
- Full infrastructure stack verification
- Cross-component interaction testing
- Performance and reliability testing

### Test Data Requirements
- Minimal test data for infrastructure verification
- Test data loader functionality validation
- Database connectivity test cases

## Technical Notes

### Design Patterns Used
- **Factory Pattern**: Test data builders
- **Template Method**: Base test configuration classes
- **Singleton**: TestContainers container instances

### Performance Considerations
- Container reuse where possible
- Efficient test data loading strategies
- Minimal test data sets for fast execution

### Security Considerations
- Test database isolation
- No production data in test environment
- Secure test configuration management