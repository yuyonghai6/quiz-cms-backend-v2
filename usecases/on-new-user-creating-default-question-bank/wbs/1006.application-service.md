# WBS 1006: Application Service

## User Story
**As a** command handler
**I want** an application service that orchestrates default question bank creation
**So that** all components (ID generation, aggregates, repository) are coordinated

---

## Acceptance Criteria
- [ ] Service coordinates ID generation
- [ ] Service creates both aggregates (QuestionBanks + Taxonomy)
- [ ] Service calls repository for persistence
- [ ] Service handles errors and returns Result<T>
- [ ] Service is transactional
- [ ] All dependencies injected via constructor

---

## TDD Cycle

### Epic and Story Annotation
```java
@Epic("Use Case On New User Create Default Question Bank Happy Path")
@Story("1006.application-service")
```

### Test Coverage Requirements
- **Unit Tests**: 100% coverage (mocked dependencies)
- **Test Count**: 10-12 tests
- **No Integration Tests**: Use mocks for repository/generator

---

## Implementation Summary

### File: `DefaultQuestionBankApplicationService.java`
**Location**: `internal-layer/question-bank/src/main/java/com/quizfun/questionbank/application/services/`

```java
@Service
public class DefaultQuestionBankApplicationService {
    private final DefaultQuestionBankRepository repository;
    private final LongIdGenerator longIdGenerator;
    
    public Result<DefaultQuestionBankResponseDto> createDefaultQuestionBank(
            Long userId, String userEmail, Map<String, String> metadata) {
        
        try {
            // 1. Generate question bank ID
            Long questionBankId = longIdGenerator.generateQuestionBankId();
            Instant now = Instant.now();
            
            // 2. Create aggregates
            QuestionBanksPerUserAggregate qbAggregate = 
                QuestionBanksPerUserAggregate.createDefault(userId, questionBankId, now);
            
            TaxonomySetAggregate taxAggregate = 
                TaxonomySetAggregate.createDefault(userId, questionBankId, now);
            
            // 3. Persist
            return repository.createDefaultQuestionBank(qbAggregate, taxAggregate);
            
        } catch (Exception ex) {
            return Result.failure("INTERNAL_ERROR: " + ex.getMessage());
        }
    }
}
```

### Key Test Cases
1. Should create default question bank successfully
2. Should generate unique question bank ID
3. Should create both aggregates with same timestamp
4. Should call repository with correct aggregates
5. Should handle repository failure
6. Should handle ID generation failure
7. Should propagate duplicate user error from repository
8. Should return error when userId is null
9. Should log operations
10. Should use same timestamp for both aggregates

---

## Definition of Done
- [x] Service implemented with all orchestration logic
- [x] Constructor injection for all dependencies
- [x] 100% test coverage with mocked dependencies
- [x] Error handling returns Result<T>
- [x] All tests passing
- [x] Proper Allure annotations
- [x] Logging added

---

## Dependencies
- **WBS 1002**: Domain aggregates (createDefault methods)
- **WBS 1005**: Repository interface
- **Global**: LongIdGenerator

---

## Estimated Effort
**3-4 hours** (0.5 day)
