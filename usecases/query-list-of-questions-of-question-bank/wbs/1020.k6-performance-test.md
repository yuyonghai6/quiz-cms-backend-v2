# User Story 1020: K6 Performance Test (Real MongoDB Replica Set)

## Goal
Load/performance testing of the Query Questions API with k6 against a running Spring Boot service configured to use a real MongoDB replica set.

## Environment
- Spring profile: `dev` (bypasses SecurityContextValidator)
- Connection string defined in `orchestration-layer/src/main/resources/application-dev.properties`
- Base URL: `http://localhost:8765`
- Test data already present in replica set

## Start/Stop Spring Boot for K6

### 1.1 Kill previous stale Spring Boot
```bash
ps aux | grep "[O]rchestrationLayerApplication" | awk '{print $2}' | xargs -r kill -9
```

### 1.2 Rebuild dependencies
```bash
mvn clean compile
```

### 1.3 Start Spring Boot with dev profile
```bash
mvn spring-boot:run -pl orchestration-layer -Dspring-boot.run.profiles=dev
```

## k6 Performance Script
Create `api-system-test/test-query-questions-perf.js` with staged load, thresholds, and HTML report. You can start from the reference snippet below (adapted from earlier draft):

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';
import { htmlReport } from 'https://raw.githubusercontent.com/benc-uk/k6-reporter/main/dist/bundle.js';

const errorRate = new Rate('errors');
const queryDuration = new Trend('query_duration');

export const options = {
  stages: [
    { duration: '30s', target: 50 },
    { duration: '1m', target: 100 },
    { duration: '2m', target: 100 },
    { duration: '30s', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
    errors: ['rate<0.01'],
  },
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:8765';
const USER_ID = __ENV.USER_ID || '1760085803933';
const QUESTION_BANK_ID = __ENV.QUESTION_BANK_ID || '1760085804015000';

export default function () {
  scenario('basic_query', `page=0&size=20`);
  scenario('category_filter', `categories=Math&page=0&size=20`);
  scenario('text_search', `searchText=equation&page=0&size=20`);
  scenario('combined_filters', `categories=Math&tags=algebra&searchText=solve&page=0&size=10`);
  sleep(1);
}

function scenario(name, qs) {
  const url = `${BASE_URL}/api/v1/users/${USER_ID}/question-banks/${QUESTION_BANK_ID}/questions?${qs}`;
  const res = http.get(url, { tags: { scenario: name } });
  const ok = check(res, {
    [`${name}: status 200`]: (r) => r.status === 200,
  });
  errorRate.add(!ok);
  queryDuration.add(res.timings.duration);
}

export function handleSummary(data) {
  const scriptPath = __ENV.K6_SCRIPT_PATH || 'test-query-questions-perf.js';
  const scriptName = scriptPath.split('/').pop().replace('.js', '');
  const reportDir = `api-system-test/reports/${scriptName}`;

  return {
    [`${reportDir}/summary-report.html`]: htmlReport(data, {
      title: 'Query Questions API - Performance Test Report',
    }),
    [`${reportDir}/summary-data.json`]: JSON.stringify(data, null, 2),
  };
}
```

## How to Run

1) Ensure Spring Boot is running with `dev` profile (see Start/Stop section).
2) Run k6 with environment variables that match your dataset:

```bash
k6 run \
  -e BASE_URL=http://localhost:8765 \
  -e USER_ID=1760085803933 \
  -e QUESTION_BANK_ID=1760085804015000 \
  -e K6_SCRIPT_PATH=api-system-test/test-query-questions-perf.js \
  api-system-test/test-query-questions-perf.js
```

## Performance Targets
- p95 response time < 500ms
- Error rate < 1%
- Steady-state throughput at 100 VUs is stable

## Reports
- HTML and JSON saved under:
```
api-system-test/reports/test-query-questions-perf/
  ├── summary-report.html
  └── summary-data.json
```

## Acceptance Criteria
- [ ] Spring Boot service runs against real replica set using `application-dev.properties`
- [ ] k6 performance script executes stages and passes thresholds
- [ ] Reports generated and stored under api-system-test/reports/
- [ ] Documented steps to start/stop and run are sufficient

## References
- Connection info: `orchestration-layer/src/main/resources/application-dev.properties`
- Functional checks example: `api-system-test/test-upsert-question-with-taxonomy.js`
- k6 docs and reporter: https://k6.io/docs/
