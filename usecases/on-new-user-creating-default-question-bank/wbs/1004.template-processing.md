# WBS 1004: Template Processing

## User Story
**As a** application service
**I want** to load and process JSON templates with variable replacement
**So that** default MongoDB documents can be created from templates

---

## Acceptance Criteria
- [ ] Load templates from classpath resources/templates/
- [ ] Replace template variables with actual values
- [ ] Detect unreplaced variables and throw exceptions
- [ ] Handle missing template files gracefully
- [ ] Thread-safe template loading
- [ ] Cache loaded templates for performance

---

## TDD Cycle

### Epic and Story Annotation
```java
@Epic("Use Case On New User Create Default Question Bank Happy Path")
@Story("1004.template-processing")
```

### Test Coverage Requirements
- **Unit Tests**: 100% coverage
- **Test Count**: 10-12 tests
- **No Integration Tests**: Pure string processing

---

## Task Breakdown

### Task 4.1: RED - Write Template Processing Tests

**File**: `TemplateVariableReplacerTest.java`
**Location**: `internal-layer/question-bank/src/test/java/com/quizfun/questionbank/infrastructure/templates/`

```java
package com.quizfun.questionbank.infrastructure.templates;

import com.quizfun.questionbank.domain.exceptions.TemplateProcessingException;
import io.qameta.allure.Epic;
import io.qameta.allure.Story;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.Map;

import static org.assertj.core.api.Assertions.*;

@Epic("Use Case On New User Create Default Question Bank Happy Path")
@Story("1004.template-processing")
@DisplayName("TemplateVariableReplacer Tests")
class TemplateVariableReplacerTest {

    private TemplateVariableReplacer replacer;

    @BeforeEach
    void setUp() {
        replacer = new TemplateVariableReplacer();
    }

    @Test
    @DisplayName("Should replace all variables in template")
    void shouldReplaceAllVariablesInTemplate() {
        // Given
        String template = """
            {
              "user_id": "{{NEW_USER_ID}}",
              "question_bank_id": "{{GENERATED_DEFAULT_BANK_ID}}",
              "_id": "{{GENERATED_OBJECT_ID}}",
              "created_at": "{{CURRENT_TIMESTAMP}}"
            }
            """;

        Map<String, String> variables = Map.of(
            "{{NEW_USER_ID}}", "123456789",
            "{{GENERATED_DEFAULT_BANK_ID}}", "1730832000000000",
            "{{GENERATED_OBJECT_ID}}", "67029a8c1234567890abcdef",
            "{{CURRENT_TIMESTAMP}}", "2025-10-06T10:30:15.123Z"
        );

        // When
        String result = replacer.replace(template, variables);

        // Then
        assertThat(result).contains("\"user_id\": \"123456789\"");
        assertThat(result).contains("\"question_bank_id\": \"1730832000000000\"");
        assertThat(result).contains("\"_id\": \"67029a8c1234567890abcdef\"");
        assertThat(result).contains("\"created_at\": \"2025-10-06T10:30:15.123Z\"");
        assertThat(result).doesNotContain("{{");
    }

    @Test
    @DisplayName("Should throw exception when variable not provided")
    void shouldThrowExceptionWhenVariableNotProvided() {
        // Given
        String template = "{ \"id\": \"{{MISSING_VAR}}\" }";
        Map<String, String> variables = Map.of();

        // When & Then
        assertThatThrownBy(() -> replacer.replace(template, variables))
            .isInstanceOf(TemplateProcessingException.class)
            .hasMessageContaining("MISSING_VAR");
    }

    @Test
    @DisplayName("Should load template from classpath")
    void shouldLoadTemplateFromClasspath() {
        // When
        String template = replacer.loadTemplate("question_banks_per_user.json_template");

        // Then
        assertThat(template).isNotNull();
        assertThat(template).contains("{{NEW_USER_ID}}");
        assertThat(template).contains("{{GENERATED_DEFAULT_BANK_ID}}");
        assertThat(template).contains("{{GENERATED_OBJECT_ID}}");
        assertThat(template).contains("{{CURRENT_TIMESTAMP}}");
    }

    @Test
    @DisplayName("Should load taxonomy template from classpath")
    void shouldLoadTaxonomyTemplateFromClasspath() {
        // When
        String template = replacer.loadTemplate("taxonomy_sets.json_template");

        // Then
        assertThat(template).isNotNull();
        assertThat(template).contains("{{NEW_USER_ID}}");
        assertThat(template).contains("{{GENERATED_DEFAULT_BANK_ID}}");
    }

    @Test
    @DisplayName("Should throw exception when template file not found")
    void shouldThrowExceptionWhenTemplateFileNotFound() {
        // When & Then
        assertThatThrownBy(() -> replacer.loadTemplate("nonexistent.json"))
            .isInstanceOf(TemplateProcessingException.class)
            .hasMessageContaining("Template not found");
    }

    @Test
    @DisplayName("Should handle empty template")
    void shouldHandleEmptyTemplate() {
        // Given
        String template = "";
        Map<String, String> variables = Map.of();

        // When
        String result = replacer.replace(template, variables);

        // Then
        assertThat(result).isEmpty();
    }

    @Test
    @DisplayName("Should handle template with no variables")
    void shouldHandleTemplateWithNoVariables() {
        // Given
        String template = "{ \"name\": \"test\" }";
        Map<String, String> variables = Map.of();

        // When
        String result = replacer.replace(template, variables);

        // Then
        assertThat(result).isEqualTo(template);
    }

    @Test
    @DisplayName("Should handle null template")
    void shouldHandleNullTemplate() {
        // When & Then
        assertThatThrownBy(() -> replacer.replace(null, Map.of()))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessageContaining("Template cannot be null");
    }

    @Test
    @DisplayName("Should handle null variables map")
    void shouldHandleNullVariablesMap() {
        // Given
        String template = "{ \"name\": \"test\" }";

        // When & Then
        assertThatThrownBy(() -> replacer.replace(template, null))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessageContaining("Variables map cannot be null");
    }

    @Test
    @DisplayName("Should replace multiple occurrences of same variable")
    void shouldReplaceMultipleOccurrencesOfSameVariable() {
        // Given
        String template = "{{USER_ID}} and {{USER_ID}} again";
        Map<String, String> variables = Map.of("{{USER_ID}}", "123");

        // When
        String result = replacer.replace(template, variables);

        // Then
        assertThat(result).isEqualTo("123 and 123 again");
    }
}
```

---

### Task 4.2: GREEN - Implement TemplateVariableReplacer

**File**: `TemplateVariableReplacer.java`
**Location**: `internal-layer/question-bank/src/main/java/com/quizfun/questionbank/infrastructure/templates/`

```java
package com.quizfun.questionbank.infrastructure.templates;

import com.quizfun.questionbank.domain.exceptions.TemplateProcessingException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Service for loading and processing JSON templates with variable replacement.
 */
@Component
public class TemplateVariableReplacer {

    private static final Logger logger = LoggerFactory.getLogger(TemplateVariableReplacer.class);
    private static final Pattern VARIABLE_PATTERN = Pattern.compile("\\{\\{([^}]+)\\}\\}");
    private static final String TEMPLATE_BASE_PATH = "templates/";

    /**
     * Replaces all template variables in the given template string.
     *
     * @param template The template string with {{VARIABLES}}
     * @param variables Map of variable names to values
     * @return Template with all variables replaced
     * @throws IllegalArgumentException if template or variables is null
     * @throws TemplateProcessingException if unreplaced variables remain
     */
    public String replace(String template, Map<String, String> variables) {
        if (template == null) {
            throw new IllegalArgumentException("Template cannot be null");
        }
        if (variables == null) {
            throw new IllegalArgumentException("Variables map cannot be null");
        }

        String result = template;

        // Replace all variables
        for (Map.Entry<String, String> entry : variables.entrySet()) {
            result = result.replace(entry.getKey(), entry.getValue());
        }

        // Check for unreplaced variables
        Matcher matcher = VARIABLE_PATTERN.matcher(result);
        if (matcher.find()) {
            String unreplacedVar = matcher.group(1);
            throw new TemplateProcessingException(
                "Unreplaced variable found: " + unreplacedVar
            );
        }

        return result;
    }

    /**
     * Loads template from classpath resources/templates/ directory.
     *
     * @param filename Template filename (e.g., "question_banks_per_user.json_template")
     * @return Template content as string
     * @throws TemplateProcessingException if template not found or cannot be read
     */
    public String loadTemplate(String filename) {
        try {
            ClassPathResource resource = new ClassPathResource(TEMPLATE_BASE_PATH + filename);

            if (!resource.exists()) {
                throw new TemplateProcessingException("Template not found: " + filename);
            }

            String content = Files.readString(
                resource.getFile().toPath(),
                StandardCharsets.UTF_8
            );

            logger.debug("Successfully loaded template: {}", filename);
            return content;

        } catch (IOException ex) {
            logger.error("Failed to load template: {}", filename, ex);
            throw new TemplateProcessingException(
                "Failed to load template: " + filename,
                ex
            );
        }
    }
}
```

---

### Task 4.3: Create TemplateProcessingException

**File**: `TemplateProcessingException.java`
**Location**: `internal-layer/question-bank/src/main/java/com/quizfun/questionbank/domain/exceptions/`

```java
package com.quizfun.questionbank.domain.exceptions;

/**
 * Exception thrown when template processing fails.
 */
public class TemplateProcessingException extends RuntimeException {

    public TemplateProcessingException(String message) {
        super(message);
    }

    public TemplateProcessingException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

---

### Task 4.4: Create Template Files

**File**: `question_banks_per_user.json_template`
**Location**: `internal-layer/question-bank/src/main/resources/templates/`

```json
{
  "_id": "{{GENERATED_OBJECT_ID}}",
  "user_id": "{{NEW_USER_ID}}",
  "default_question_bank_id": "{{GENERATED_DEFAULT_BANK_ID}}",
  "question_banks": [
    {
      "bank_id": "{{GENERATED_DEFAULT_BANK_ID}}",
      "name": "Default Question Bank",
      "description": "Your default question bank for getting started with quiz creation",
      "is_active": true,
      "created_at": "{{CURRENT_TIMESTAMP}}",
      "updated_at": "{{CURRENT_TIMESTAMP}}"
    }
  ],
  "created_at": "{{CURRENT_TIMESTAMP}}",
  "updated_at": "{{CURRENT_TIMESTAMP}}"
}
```

**File**: `taxonomy_sets.json_template`
**Location**: `internal-layer/question-bank/src/main/resources/templates/`

```json
{
  "_id": "{{GENERATED_OBJECT_ID}}",
  "user_id": "{{NEW_USER_ID}}",
  "question_bank_id": "{{GENERATED_DEFAULT_BANK_ID}}",
  "categories": {
    "level_1": {
      "id": "general",
      "name": "General",
      "slug": "general",
      "parent_id": null
    }
  },
  "tags": [
    {
      "id": "beginner",
      "name": "Beginner",
      "color": "#28a745"
    },
    {
      "id": "practice",
      "name": "Practice",
      "color": "#007bff"
    },
    {
      "id": "quick-test",
      "name": "Quick Test",
      "color": "#6f42c1"
    }
  ],
  "quizzes": [],
  "current_difficulty_level": {
    "level": "easy",
    "numeric_value": 1,
    "description": "Suitable for beginners and initial learning"
  },
  "available_difficulty_levels": [
    {
      "level": "easy",
      "numeric_value": 1,
      "description": "Suitable for beginners and initial learning"
    },
    {
      "level": "medium",
      "numeric_value": 2,
      "description": "Intermediate knowledge required"
    },
    {
      "level": "hard",
      "numeric_value": 3,
      "description": "Advanced understanding needed"
    }
  ],
  "created_at": "{{CURRENT_TIMESTAMP}}",
  "updated_at": "{{CURRENT_TIMESTAMP}}"
}
```

---

## Definition of Done

- [x] Template loading from classpath works
- [x] Variable replacement functional
- [x] Unreplaced variable detection works
- [x] Template files created in resources/templates/
- [x] TemplateProcessingException created
- [x] 100% test coverage
- [x] All tests passing
- [x] Proper Allure annotations
- [x] Code review ready

---

## Dependencies
**None** - Independent utility

---

## Estimated Effort
**4-6 hours** (1 day including template creation)

---

## Notes
- Templates stored in src/main/resources/templates/
- Simple string replacement (not JSON parsing)
- Thread-safe (no mutable state)
- Can add template caching later for performance
