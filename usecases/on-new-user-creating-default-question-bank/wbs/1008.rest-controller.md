# WBS 1008: REST Controller

## User Story
**As an** external user management system
**I want** an HTTP endpoint to create default question banks
**So that** new users get question banks via REST API

---

## Acceptance Criteria
- [ ] POST /api/users/default-question-bank endpoint
- [ ] Accepts CreateDefaultQuestionBankRequestDto
- [ ] Returns 201 Created on success
- [ ] Returns 409 Conflict for duplicate user
- [ ] Returns 400 Bad Request for invalid input
- [ ] Returns 500 Internal Server Error for system failures
- [ ] Response includes X-Question-Bank-ID header
- [ ] Request validation with @Valid

---

## TDD Cycle

### Epic and Story Annotation
```java
@Epic("Use Case On New User Create Default Question Bank Happy Path")
@Story("1008.rest-controller")
```

### Test Coverage Requirements
- **MockMvc Tests**: 100% coverage
- **Test Count**: 12-15 tests

---

## Implementation Summary

### File: `DefaultQuestionBankController.java`
**Location**: `orchestration-layer/src/main/java/com/quizfun/orchestrationlayer/controllers/`

```java
@RestController
@RequestMapping("/api/users/default-question-bank")
@Validated
public class DefaultQuestionBankController {
    
    private final IMediator mediator;
    
    @PostMapping
    public ResponseEntity<Result<DefaultQuestionBankResponseDto>> createDefaultQuestionBank(
            @Valid @RequestBody CreateDefaultQuestionBankRequestDto request) {
        
        try {
            OnNewUserCreateDefaultQuestionBankCommand command = 
                new OnNewUserCreateDefaultQuestionBankCommand(
                    request.getUserId(),
                    request.getUserEmail(),
                    request.getMetadata()
                );
            
            Result<DefaultQuestionBankResponseDto> result = mediator.send(command);
            
            if (result.success()) {
                return ResponseEntity
                    .status(HttpStatus.CREATED)
                    .header("X-Question-Bank-ID", result.data().getQuestionBankId().toString())
                    .body(result);
            } else {
                return mapErrorToHttpStatus(result);
            }
            
        } catch (IllegalArgumentException ex) {
            return ResponseEntity.badRequest()
                .body(Result.failure("VALIDATION_ERROR: " + ex.getMessage()));
        }
    }
    
    private ResponseEntity<Result<DefaultQuestionBankResponseDto>> mapErrorToHttpStatus(
            Result<DefaultQuestionBankResponseDto> result) {
        
        if (result.message().startsWith("DUPLICATE_USER")) {
            return ResponseEntity.status(HttpStatus.CONFLICT).body(result);
        } else if (result.message().startsWith("DATABASE_ERROR") || 
                   result.message().startsWith("INTERNAL_ERROR")) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(result);
        } else {
            return ResponseEntity.badRequest().body(result);
        }
    }
}
```

### Request DTO

```java
public class CreateDefaultQuestionBankRequestDto {
    @NotNull
    @Positive
    private Long userId;
    
    @Email
    private String userEmail;
    
    private Map<String, String> metadata;
    
    // Getters, setters, builder
}
```

### Key Test Cases (MockMvc)
1. Should return 201 Created when successful
2. Should return 400 Bad Request when userId is null
3. Should return 400 Bad Request when userId is negative
4. Should return 400 Bad Request when email format invalid
5. Should return 409 Conflict when user already exists
6. Should return 500 Internal Server Error on database error
7. Should include X-Question-Bank-ID header on success
8. Should validate request body with @Valid
9. Should handle missing request body
10. Should handle empty metadata map
11. Should log request details
12. Should send command via mediator

---

## Definition of Done
- [x] Controller endpoint implemented
- [x] Request/Response DTOs created
- [x] HTTP status code mapping correct
- [x] Request validation working
- [x] 100% MockMvc test coverage
- [x] All tests passing
- [x] Proper Allure annotations
- [x] Exception handlers added

---

## Dependencies
- **WBS 1001**: Command class
- **WBS 1007**: Command handler
- **Global**: Mediator

---

## Estimated Effort
**6-8 hours** (1 day)

---

## API Contract

### Request
```http
POST /api/users/default-question-bank
Content-Type: application/json

{
  "userId": 123456789,
  "userEmail": "user@example.com",
  "metadata": {
    "createdBy": "user-management-system",
    "requestId": "req-12345"
  }
}
```

### Success Response (201)
```http
HTTP/1.1 201 Created
X-Question-Bank-ID: 1730832000000000
Content-Type: application/json

{
  "success": true,
  "message": "Default question bank created successfully for user 123456789",
  "data": {
    "userId": 123456789,
    "questionBankId": 1730832000000000,
    "questionBankName": "Default Question Bank",
    "isActive": true,
    "taxonomySetCreated": true,
    "availableTaxonomy": { ... },
    "createdAt": "2025-10-06T10:30:15.123Z"
  }
}
```

### Error Response (409)
```http
HTTP/1.1 409 Conflict
Content-Type: application/json

{
  "success": false,
  "message": "DUPLICATE_USER: User 123456789 already has a default question bank",
  "data": null
}
```
