# User Story 1010: Testcontainer MongoDB Setup and Configuration

## User Story

**As a** backend developer
**I want** to set up Testcontainer MongoDB with simplified configuration for the query module
**So that** integration tests can run against a real MongoDB instance without manual database setup

## Acceptance Criteria

- [ ] Question-bank-query module POM created with correct dependencies
- [ ] Internal-layer parent POM updated to include new module
- [ ] Testcontainer MongoDB starts successfully with mongo:8.0 image
- [ ] MongoDB connection URI is dynamically configured using `@DynamicPropertySource`
- [ ] MongoTemplate is auto-configured by Spring Boot (no manual bean creation)
- [ ] Read preference is set to "primary" for strong consistency
- [ ] Container ports are dynamically mapped (Testcontainers handles port allocation)
- [ ] Container reuse is disabled for test isolation
- [ ] Test application uses `@ActiveProfiles("test")` to activate test configuration
- [ ] Integration test can successfully connect and perform basic CRUD operations
- [ ] Test verifies MongoDB connection and basic collection operations
- [ ] All tests pass with JaCoCo coverage > 70%
- [ ] Allure annotations are correctly applied (@Epic and @Story only, NO @Feature)

---

## TDD Cycle

### Allure Annotations Format

```java
@Epic("Use Case Query List of Questions of Question Bank")
@Story("1010.testcontainer-mongodb-setup-and-configuration")
```

**Important**: Do NOT use `@Feature` annotation. Only use `@Epic` and `@Story`.

---

## Phase 1: RED (Write Failing Test)

### Objective
Write a failing integration test that verifies Testcontainer MongoDB setup and basic operations.

### Tasks

#### Task 1.1: Create Question Bank Query Module POM

**File**: `internal-layer/question-bank-query/pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.quizfun</groupId>
        <artifactId>internal-layer</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>

    <artifactId>question-bank-query</artifactId>
    <name>Question Bank Query Module</name>
    <description>Query module for CQRS read operations on questions</description>

    <dependencies>
        <!-- Global Shared Library (for Result, Mediator) -->
        <dependency>
            <groupId>com.quizfun</groupId>
            <artifactId>global-shared-library</artifactId>
            <version>${project.version}</version>
        </dependency>

        <!-- Spring Boot Starter Data MongoDB -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb</artifactId>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- Spring Boot Starter Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Testcontainers MongoDB -->
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>mongodb</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Testcontainers JUnit Jupiter -->
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>junit-jupiter</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Allure JUnit 5 -->
        <dependency>
            <groupId>io.qameta.allure</groupId>
            <artifactId>allure-junit5</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- AssertJ -->
        <dependency>
            <groupId>org.assertj</groupId>
            <artifactId>assertj-core</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
```

#### Task 1.2: Update Internal Layer Parent POM

**File**: `internal-layer/pom.xml`

Add the new module to the `<modules>` section:

```xml
<modules>
    <module>shared</module>
    <module>question-bank</module>
    <module>question-bank-query</module>  <!-- ADD THIS -->
</modules>
```

#### Task 1.3: Create Test Configuration Class

**File**: `internal-layer/question-bank-query/src/test/java/com/quizfun/questionbankquery/config/TestContainersMongoDBConfigurationTest.java`

```java
package com.quizfun.questionbankquery.config;

import io.qameta.allure.Epic;
import io.qameta.allure.Story;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.testcontainers.containers.MongoDBContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.util.HashMap;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

@Epic("Use Case Query List of Questions of Question Bank")
@Story("1010.testcontainer-mongodb-setup-and-configuration")
@Testcontainers
@SpringBootTest
@ActiveProfiles("test")
@DisplayName("Testcontainer MongoDB Configuration Tests")
class TestContainersMongoDBConfigurationTest {

    private static final String MONGO_IMAGE_VERSION = "mongo:8.0";
    private static final int MONGO_INTERNAL_PORT = 27017;
    private static final String TEST_COLLECTION_NAME = "test_collection";
    private static final String TEST_FIELD_NAME = "testField";
    private static final String TEST_FIELD_VALUE = "testValue";

    @Container
    static MongoDBContainer mongoContainer = new MongoDBContainer(MONGO_IMAGE_VERSION)
            .withExposedPorts(MONGO_INTERNAL_PORT)
            .withReuse(false);

    @DynamicPropertySource
    static void mongoProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.data.mongodb.uri", mongoContainer::getReplicaSetUrl);
        registry.add("spring.data.mongodb.read-preference", () -> "primary");
    }

    @Autowired
    private MongoTemplate mongoTemplate;

    @Test
    @DisplayName("Should start MongoDB container successfully")
    void shouldStartMongoDBContainerSuccessfully() {
        // GIVEN: Testcontainer is configured

        // WHEN: Test runs

        // THEN: Container should be running
        assertThat(mongoContainer.isRunning())
                .as("MongoDB container should be running")
                .isTrue();
    }

    @Test
    @DisplayName("Should connect to MongoDB with correct URI")
    void shouldConnectToMongoDBWithCorrectURI() {
        // GIVEN: MongoDB container is running

        // WHEN: Getting replica set URL
        String replicaSetUrl = mongoContainer.getReplicaSetUrl();

        // THEN: URI should be valid and contain correct host
        assertThat(replicaSetUrl)
                .as("Replica set URL should not be null")
                .isNotNull()
                .contains("mongodb://");
    }

    @Test
    @DisplayName("Should auto-configure MongoTemplate bean")
    void shouldAutoConfigureMongoTemplateBean() {
        // GIVEN: Spring Boot context is loaded

        // WHEN: MongoTemplate is injected

        // THEN: MongoTemplate should be available
        assertThat(mongoTemplate)
                .as("MongoTemplate should be auto-configured by Spring Boot")
                .isNotNull();
    }

    @Test
    @DisplayName("Should perform basic CRUD operations on test collection")
    void shouldPerformBasicCRUDOperationsOnTestCollection() {
        // GIVEN: MongoDB is connected
        Map<String, Object> testDocument = createTestDocument();

        // WHEN: Inserting a test document
        mongoTemplate.insert(testDocument, TEST_COLLECTION_NAME);

        // THEN: Document should be retrievable
        Map<String, Object> retrievedDoc = mongoTemplate.findById(
                testDocument.get("_id"),
                Map.class,
                TEST_COLLECTION_NAME
        );

        assertThat(retrievedDoc)
                .as("Retrieved document should not be null")
                .isNotNull();
        assertThat(retrievedDoc.get(TEST_FIELD_NAME))
                .as("Test field should match inserted value")
                .isEqualTo(TEST_FIELD_VALUE);

        // CLEANUP: Remove test document
        mongoTemplate.dropCollection(TEST_COLLECTION_NAME);
    }

    /**
     * Creates a test document with common fields for testing.
     *
     * @return A map representing a test document
     */
    private Map<String, Object> createTestDocument() {
        Map<String, Object> document = new HashMap<>();
        document.put(TEST_FIELD_NAME, TEST_FIELD_VALUE);
        document.put("timestamp", System.currentTimeMillis());
        return document;
    }

    @Test
    @DisplayName("Should verify read preference is set to primary")
    void shouldVerifyReadPreferenceIsSetToPrimary() {
        // GIVEN: MongoDB is configured with read preference

        // WHEN: Getting database name
        String dbName = mongoTemplate.getDb().getName();

        // THEN: Database should be accessible (primary read)
        assertThat(dbName)
                .as("Database name should not be null")
                .isNotNull();

        // Verify collection operations work (requires primary read)
        assertThat(mongoTemplate.getCollectionNames())
                .as("Should be able to list collections with primary read preference")
                .isNotNull();
    }

    @Test
    @DisplayName("Should dynamically map container ports")
    void shouldDynamicallyMapContainerPorts() {
        // GIVEN: Container is configured with exposed port

        // WHEN: Getting dynamically mapped port
        Integer mappedPort = mongoContainer.getFirstMappedPort();

        // THEN: Port should be mapped to a random external port
        assertThat(mappedPort)
                .as("Container should have a dynamically mapped external port")
                .isNotNull()
                .isGreaterThan(0);

        // AND: Internal port should be standard MongoDB port
        assertThat(mongoContainer.getExposedPorts())
                .as("Container should expose internal MongoDB port")
                .contains(MONGO_INTERNAL_PORT);
    }
}
```

#### Task 1.4: Create Spring Boot Test Application Configuration

**File**: `internal-layer/question-bank-query/src/test/java/com/quizfun/questionbankquery/TestQuestionBankQueryApplication.java`

```java
package com.quizfun.questionbankquery;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * Test application for question-bank-query module integration tests.
 * This is a minimal Spring Boot application used only for testing purposes.
 */
@SpringBootApplication
public class TestQuestionBankQueryApplication {

    public static void main(String[] args) {
        SpringApplication.run(TestQuestionBankQueryApplication.class, args);
    }
}
```

#### Task 1.5: Create Test Application Properties

**File**: `internal-layer/question-bank-query/src/test/resources/application-test.properties`

```properties
# MongoDB Configuration (overridden by @DynamicPropertySource)
spring.data.mongodb.uri=mongodb://localhost:27017/test-quizfun-query
spring.data.mongodb.read-preference=primary

# Logging
logging.level.org.springframework.data.mongodb=DEBUG
logging.level.org.testcontainers=INFO
logging.level.com.quizfun.questionbankquery=DEBUG

# Testcontainers
testcontainers.reuse.enable=false
```

#### Task 1.6: Run the Test (Should FAIL)

```bash
mvn clean test -pl internal-layer/question-bank-query -Dtest=TestContainersMongoDBConfigurationTest
```

**Expected Result**: Tests should FAIL because:
- Module structure doesn't exist yet
- Spring Boot test application is not configured
- Dependencies may be missing
- MongoTemplate may not be auto-configured correctly

---

## Phase 2: GREEN (Make Tests Pass)

### Objective
Implement minimal configuration to make all tests pass.

### Tasks

#### Task 2.1: Verify Module Structure

Ensure the module directory structure exists:

```
internal-layer/question-bank-query/
├── pom.xml
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── quizfun/
│   │   │           └── questionbankquery/
│   │   └── resources/
│   │       └── application.properties
│   └── test/
│       ├── java/
│       │   └── com/
│       │       └── quizfun/
│       │           └── questionbankquery/
│       │               ├── config/
│       │               │   └── TestContainersMongoDBConfigurationTest.java
│       │               └── TestQuestionBankQueryApplication.java
│       └── resources/
│           └── application-test.properties
```

#### Task 2.2: Create Main Application Properties (Placeholder)

**File**: `internal-layer/question-bank-query/src/main/resources/application.properties`

```properties
# MongoDB Configuration (placeholder, will be overridden in production)
spring.data.mongodb.uri=mongodb://localhost:27017/quizfun-query
spring.data.mongodb.read-preference=primary

# Application Name
spring.application.name=question-bank-query

# Logging
logging.level.org.springframework.data.mongodb=INFO
logging.level.com.quizfun.questionbankquery=INFO
```

#### Task 2.3: Update Parent POM Dependency Management

**File**: `pom.xml` (root)

Ensure Testcontainers BOM is included:

```xml
<dependencyManagement>
    <dependencies>
        <!-- Testcontainers BOM -->
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>testcontainers-bom</artifactId>
            <version>1.19.3</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

#### Task 2.4: Run Tests (Should PASS)

```bash
mvn clean test -pl internal-layer/question-bank-query -Dtest=TestContainersMongoDBConfigurationTest
```

**Expected Result**: All 6 tests should PASS:
- ✅ Should start MongoDB container successfully
- ✅ Should connect to MongoDB with correct URI
- ✅ Should auto-configure MongoTemplate bean
- ✅ Should perform basic CRUD operations on test collection
- ✅ Should verify read preference is set to primary
- ✅ Should expose container on port 27017

---

## Phase 3: REFACTOR (Improve Code Quality)

### Objective
Improve test code quality, add documentation, and ensure best practices.

### Tasks

#### Task 3.1: Add Javadoc to Test Configuration

Update `TestContainersMongoDBConfigurationTest.java` with comprehensive Javadoc:

```java
/**
 * Integration tests for Testcontainer MongoDB configuration in the query module.
 *
 * <p>This test class verifies that:
 * <ul>
 *   <li>MongoDB Testcontainer starts successfully with mongo:8.0 image</li>
 *   <li>Connection URI is dynamically configured via @DynamicPropertySource</li>
 *   <li>MongoTemplate is auto-configured by Spring Boot</li>
 *   <li>Read preference is set to "primary" for strong consistency</li>
 *   <li>Container port 27017 is exposed correctly</li>
 *   <li>Basic CRUD operations work as expected</li>
 * </ul>
 *
 * <p><strong>Key Differences from Command Module:</strong>
 * <ul>
 *   <li>Uses @DynamicPropertySource instead of manual bean creation</li>
 *   <li>Relies on Spring Boot auto-configuration for MongoTemplate</li>
 *   <li>No transaction management required (read-only queries)</li>
 *   <li>Container reuse disabled for test isolation</li>
 * </ul>
 *
 * @see org.springframework.data.mongodb.core.MongoTemplate
 * @see org.testcontainers.containers.MongoDBContainer
 */
```

#### Task 3.2: Verify Constants Are Applied

Verify that the RED phase code already includes constants extracted:
- ✅ `MONGO_IMAGE_VERSION = "mongo:8.0"`
- ✅ `MONGO_INTERNAL_PORT = 27017`
- ✅ `TEST_COLLECTION_NAME = "test_collection"`
- ✅ `TEST_FIELD_NAME = "testField"`
- ✅ `TEST_FIELD_VALUE = "testValue"`

No changes needed - constants were added during RED phase.

#### Task 3.3: Verify Helper Method Is Applied

Verify that `createTestDocument()` helper method is already being used in the CRUD test. No changes needed - refactoring was done during RED phase.

#### Task 3.4: Add Note on Port Mapping Clarification

Update the Notes section to clarify Testcontainers port mapping behavior (see Notes section updates below).

#### Task 3.5: Run Tests with Coverage Check

```bash
mvn clean verify -pl internal-layer/question-bank-query
```

Verify:
- ✅ All tests pass
- ✅ JaCoCo coverage > 70%
- ✅ Allure results generated in `target/allure-results/`

#### Task 3.6: Generate Allure Report

```bash
mvn allure:report -pl internal-layer/question-bank-query
```

Verify in Allure report:
- ✅ Epic: "Use Case Query List of Questions of Question Bank"
- ✅ Story: "1010.testcontainer-mongodb-setup-and-configuration"
- ✅ All 6 tests displayed correctly
- ✅ No @Feature annotation present

---

## Definition of Done

- [ ] All tests pass with green status
- [ ] JaCoCo code coverage >= 70%
- [ ] Allure annotations correctly applied (@Epic and @Story only)
- [ ] Allure report generated successfully
- [ ] Testcontainer MongoDB starts and stops cleanly
- [ ] MongoTemplate is auto-configured by Spring Boot
- [ ] No manual bean creation required (unlike command module)
- [ ] Read preference set to "primary"
- [ ] Container port 27017 exposed correctly
- [ ] Basic CRUD operations verified
- [ ] Code is properly documented with Javadoc
- [ ] Constants extracted for magic values
- [ ] Test naming follows conventions
- [ ] No Checkstyle violations
- [ ] No SonarLint warnings
- [ ] Code reviewed and approved

---

## Testing Checklist

### Unit Tests
- [ ] N/A (This is infrastructure setup, integration tests only)

### Integration Tests
- [ ] ✅ Container startup verification
- [ ] ✅ Connection URI validation
- [ ] ✅ MongoTemplate auto-configuration
- [ ] ✅ Basic CRUD operations
- [ ] ✅ Read preference verification
- [ ] ✅ Port exposure verification

### Edge Cases
- [ ] Container fails to start (should throw clear exception)
- [ ] Invalid connection URI (handled by Testcontainers)
- [ ] Port conflict (handled by dynamic port mapping)

### Performance
- [ ] Container startup time < 30 seconds
- [ ] Basic CRUD operations < 100ms

### Allure Reporting
- [ ] Epic annotation present: "Use Case Query List of Questions of Question Bank"
- [ ] Story annotation present: "1010.testcontainer-mongodb-setup-and-configuration"
- [ ] No @Feature annotation used
- [ ] All 6 tests visible in Allure report
- [ ] Test descriptions are clear and readable

---

## Estimated Effort

- **RED Phase**: 1.5 hours
- **GREEN Phase**: 1 hour
- **REFACTOR Phase**: 1 hour
- **Total**: 3.5 hours

---

## Dependencies

- None (this is the foundation for all subsequent user stories)

---

## Notes

### Key Differences from Command Module

1. **Simplified Configuration**: Uses `@DynamicPropertySource` instead of manual `MongoTransactionManager` and `MongoTemplate` bean creation
2. **No Transaction Management**: Query operations are read-only, no transaction support needed
3. **Auto-Configuration**: Leverages Spring Boot's MongoDB auto-configuration
4. **Container Reuse**: Disabled for test isolation (command module enables reuse for performance)

### Why This Approach?

- **Simplicity**: Query module doesn't need complex transaction setup
- **Maintainability**: Less boilerplate code to maintain
- **Spring Boot Conventions**: Follows Spring Boot's "convention over configuration" principle
- **Test Isolation**: Each test run starts with a clean container state

### Testcontainers Port Mapping Clarification

**Important**: Testcontainers uses dynamic port mapping:

- **Internal Port**: 27017 (MongoDB default inside container)
- **External Port**: Random port assigned by Docker (e.g., 32768, 49153, etc.)
- **Why**: Prevents port conflicts when running multiple tests

```java
// ❌ WRONG: Don't assume port 27017 is the external port
.withExposedPorts(27017)  // This is NOT the external port

// ✅ CORRECT: Expose MongoDB's internal port 27017
.withExposedPorts(27017)  // Internal port

// ✅ CORRECT: Get the dynamically mapped external port
Integer externalPort = mongoContainer.getFirstMappedPort(); // e.g., 32768
```

The `@DynamicPropertySource` handles this automatically by calling `mongoContainer.getReplicaSetUrl()`, which includes the correct external port.

### Reference

- Testcontainers MongoDB: https://www.testcontainers.org/modules/databases/mongodb/
- Spring Boot MongoDB: https://docs.spring.io/spring-boot/docs/current/reference/html/data.html#data.nosql.mongodb
- Testcontainers Port Mapping: https://www.testcontainers.org/features/networking/
