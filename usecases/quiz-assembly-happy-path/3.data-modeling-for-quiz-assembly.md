# Data Modeling for Quiz Assembly (MongoDB)

## Overview and Design Philosophy

This data model extends the existing question bank system to support quiz assembly functionality. The design prioritizes **performance**, **data integrity**, and **multi-tenant isolation** while enabling efficient aggregation of questions into cohesive quiz units.

### Core Design Principles

1. **Question Snapshot Strategy**: Embed essential question data to ensure quiz integrity even if source questions change
2. **Multi-tenant Isolation**: Every document includes `user_id` and `question_bank_id` for complete data separation
3. **UUID v7 Identifiers**: Use UUID v7 for quiz_assembly_id and source_question_id for better performance and chronological ordering
4. **Upsert-Friendly Design**: Support efficient insert/update operations using compound unique indexes
5. **Cross-Module Integration**: Maintain loose coupling with question-bank module through question snapshots

## Collection Design

### 1. `quiz_assemblies` (New Collection)

**Purpose**: Primary collection for storing quiz assemblies with embedded question snapshots

**Why This Approach**:
- **Embedded Question Snapshots**: Ensures quiz integrity even if source questions are modified or deleted
- **Self-Contained Documents**: Reduces cross-collection queries for quiz display and execution
- **Efficient Upsert Operations**: Compound unique index on (user_id, question_bank_id, quiz_assembly_id) enables atomic upsert
- **Multi-Tenant Isolation**: Complete data separation through user_id and question_bank_id filters

```javascript
// Document Structure Example
{
  _id: ObjectId("670123456789abcdef012345"),
  user_id: 12345,                                    // Long format
  question_bank_id: "018f-a1b2-c3d4-e5f6-123456789abc",  // UUID v7
  quiz_assembly_id: "018f-b2c3-d4e5-f6a7-234567890def",  // UUID v7 (for upsert)

  quiz_metadata: {
    title: "JavaScript Fundamentals Assessment",
    description: "Comprehensive evaluation covering variables, functions, arrays, and objects",
    total_points: 85,
    estimated_duration_minutes: 60,
    question_count: 17,
    difficulty_distribution: {
      easy: 8,
      medium: 7,
      hard: 2
    }
  },

  assembled_questions: [
    {
      question_reference_id: ObjectId("670123456789abcdef012346"), // References questions._id
      source_question_id: "018f-c3d4-e5f6-a7b8-345678901234",     // UUID v7 from original question
      display_order: 1,
      points_override: null,                         // Optional override of original points
      included_at: ISODate("2025-09-29T10:30:00Z"), // When added to this assembly

      // Immutable snapshot of essential question data
      question_snapshot: {
        question_type: "mcq",
        title: "JavaScript Variable Declaration",
        content: "<p>Which keyword is used to declare a block-scoped variable in JavaScript?</p>",
        points: 5,
        status: "published",

        // Type-specific data snapshot
        mcq_data: {
          options: [
            {
              id: 1,
              text: "let",
              is_correct: true,
              explanation: "Correct! 'let' declares block-scoped variables"
            },
            {
              id: 2,
              text: "var",
              is_correct: false,
              explanation: "Incorrect. 'var' is function-scoped, not block-scoped"
            },
            {
              id: 3,
              text: "const",
              is_correct: false,
              explanation: "Incorrect. 'const' declares constants, not variables"
            }
          ],
          shuffle_options: false,
          allow_multiple_correct: false,
          time_limit_seconds: 30
        },

        // Taxonomy snapshot for context
        taxonomy_snapshot: {
          categories: {
            level_1: { id: "tech", name: "Technology" },
            level_2: { id: "prog", name: "Programming" },
            level_3: { id: "web_dev", name: "Web Development" },
            level_4: { id: "javascript", name: "JavaScript" }
          },
          tags: [
            { id: "variables", name: "Variables", color: "#f7df1e" },
            { id: "block-scope", name: "Block Scope", color: "#61dafb" }
          ],
          difficulty_level: {
            level: "easy",
            numeric_value: 1,
            description: "Suitable for beginners"
          }
        }
      }
    },
    {
      question_reference_id: ObjectId("670123456789abcdef012347"),
      source_question_id: "018f-d4e5-f6a7-b8c9-456789012345",
      display_order: 2,
      points_override: 8,                            // Override original 5 points to 8
      included_at: ISODate("2025-09-29T10:30:00Z"),

      question_snapshot: {
        question_type: "essay",
        title: "JavaScript Array Methods Comparison",
        content: "<p>Compare and contrast <code>map()</code>, <code>filter()</code>, and <code>reduce()</code> methods in JavaScript. Provide examples showing when to use each method.</p>",
        points: 5,                                   // Original points (will be overridden)
        status: "published",

        essay_data: {
          prompt: "Compare and contrast map(), filter(), and reduce() methods in JavaScript. Provide examples showing when to use each method.",
          min_words: 200,
          max_words: 800,
          rubric: [
            {
              criteria: "Understanding of map() method",
              max_points: 20,
              description: "Correctly explains map() transforms array elements"
            },
            {
              criteria: "Understanding of filter() method",
              max_points: 20,
              description: "Correctly explains filter() selects array elements"
            },
            {
              criteria: "Understanding of reduce() method",
              max_points: 20,
              description: "Correctly explains reduce() accumulates values"
            },
            {
              criteria: "Code examples and practical usage",
              max_points: 40,
              description: "Provides clear, working examples for each method"
            }
          ],
          allow_file_upload: true
        },

        taxonomy_snapshot: {
          categories: {
            level_1: { id: "tech", name: "Technology" },
            level_2: { id: "prog", name: "Programming" },
            level_3: { id: "web_dev", name: "Web Development" },
            level_4: { id: "javascript", name: "JavaScript" }
          },
          tags: [
            { id: "array-methods", name: "Array Methods", color: "#f7df1e" },
            { id: "functional-programming", name: "Functional Programming", color: "#764abc" }
          ],
          difficulty_level: {
            level: "medium",
            numeric_value: 2,
            description: "Intermediate knowledge required"
          }
        }
      }
    }
  ],

  assembly_settings: {
    randomize_question_order: false,
    allow_navigation: true,
    allow_review: true,
    time_limit_minutes: 60,
    auto_submit_on_timeout: true,
    show_progress_indicator: true,
    allow_question_skipping: true,
    require_all_questions_attempted: false
  },

  metadata: {
    created_by: 12345,
    last_modified_by: 12345,
    version: 1,
    assembly_source: "manual_selection",           // manual_selection, auto_generated, imported
    original_question_count: 17,                   // Track if questions were removed
    last_question_sync: ISODate("2025-09-29T10:30:00Z"), // Last time questions were synced
    is_template: false,                            // Can be used as template for other assemblies
    template_category: null                        // Category if used as template
  },

  // Audit fields
  created_at: ISODate("2025-09-29T10:30:00Z"),
  updated_at: ISODate("2025-09-29T10:30:00Z"),
  archived_at: null,

  // Statistics (calculated fields)
  statistics: {
    average_time_per_question: 3.5,               // minutes (estimated)
    complexity_score: 2.1,                       // 1-5 scale based on question types and difficulty
    topic_coverage: [
      { topic: "variables", question_count: 5 },
      { topic: "functions", question_count: 4 },
      { topic: "arrays", question_count: 4 },
      { topic: "objects", question_count: 4 }
    ]
  }
}
```

**Key Design Decisions**:
- **Question Snapshots**: Complete question data embedded to ensure quiz integrity and performance
- **Points Override**: Allow per-assembly customization of question points while preserving original values
- **Taxonomy Snapshots**: Include essential taxonomy context for reporting and analysis
- **Assembly Settings**: Comprehensive configuration for quiz behavior and constraints
- **Audit Trail**: Complete tracking of creation, modification, and versioning
- **Statistics**: Pre-calculated metrics for performance dashboards

## Index Strategy and Rationale

### `quiz_assemblies` Indexes

```javascript
// Primary unique constraint for upsert operations
db.quiz_assemblies.createIndex(
  { user_id: 1, question_bank_id: 1, quiz_assembly_id: 1 },
  { unique: true, name: "ux_user_bank_assembly_id" }
);

// User's quiz assemblies listing
db.quiz_assemblies.createIndex(
  { user_id: 1, question_bank_id: 1, created_at: -1 },
  { name: "ix_user_bank_created_desc" }
);

// Active (non-archived) assemblies
db.quiz_assemblies.createIndex(
  { user_id: 1, question_bank_id: 1, archived_at: 1 },
  { name: "ix_user_bank_archived" }
);

// Query by source question ID (for impact analysis)
db.quiz_assemblies.createIndex(
  { user_id: 1, question_bank_id: 1, "assembled_questions.source_question_id": 1 },
  { name: "ix_user_bank_source_question" }
);

// Template assemblies
db.quiz_assemblies.createIndex(
  { user_id: 1, question_bank_id: 1, "metadata.is_template": 1 },
  { name: "ix_user_bank_template" }
);

// Search by title and description
db.quiz_assemblies.createIndex(
  { user_id: 1, question_bank_id: 1, "quiz_metadata.title": "text", "quiz_metadata.description": "text" },
  { name: "ix_user_bank_text_search" }
);
```

**Rationale**: These indexes support the primary access patterns: upsert operations, user assembly listing, impact analysis when questions change, template management, and full-text search capabilities.

## Relationships and Data Flow

### Entity Relationships
```
User (1) ←→ (1) question_banks_per_user
    ↓
Question Banks (array embedded)
    ↓
(user_id, question_bank_id) → quiz_assemblies (1:many)
    ↓
quiz_assemblies.assembled_questions[].question_reference_id → questions._id (many:1)
    ↓
quiz_assemblies.assembled_questions[].source_question_id → questions.source_question_id (many:1)
```

### Cross-Module Data Flow
```
Quiz Assembly Creation Flow:
1. quiz-assembly module ──(query)──▶ question-bank module
2. question-bank module ──(return)──▶ quiz-assembly module (question data)
3. quiz-assembly module ──(create snapshots)──▶ quiz_assemblies collection
4. quiz_assemblies collection ──(store)──▶ MongoDB

Quiz Assembly Retrieval Flow:
1. Client ──(request)──▶ quiz-assembly module
2. quiz-assembly module ──(query)──▶ quiz_assemblies collection
3. quiz_assemblies collection ──(return)──▶ quiz-assembly module (complete data)
4. quiz-assembly module ──(response)──▶ Client (no additional queries needed)
```

### Data Integrity Rules
1. **User Ownership Constraint**: `user_id` must reference valid user with access to `question_bank_id`
2. **Question Reference Constraint**: `question_reference_id` should reference existing questions._id (soft constraint)
3. **Quiz Assembly Scoping**: All operations must include `(user_id, question_bank_id)` filters
4. **UUID Format Validation**: `quiz_assembly_id` and `source_question_id` must be valid UUID v7 format
5. **Points Consistency**: If `points_override` is null, use `question_snapshot.points`

## Operational Workflows

### Quiz Assembly Creation Workflow

**Input Processing**:
```javascript
// Input from AssembleQuizCommand
const command = {
  userId: 12345,
  questionBankId: "018f-a1b2-c3d4-e5f6-123456789abc",
  quizAssemblyId: "018f-b2c3-d4e5-f6a7-234567890def",
  selectedQuestionIds: [
    "018f-c3d4-e5f6-a7b8-345678901234",
    "018f-d4e5-f6a7-b8c9-456789012345"
  ],
  quizMetadata: {
    title: "JavaScript Fundamentals Assessment",
    description: "Comprehensive evaluation"
  },
  assemblySettings: {
    randomizeQuestionOrder: false,
    timeLimitMinutes: 60
  }
};
```

**Question Retrieval and Snapshot Creation**:
```javascript
// 1. Query questions from question-bank module
const questions = await questionRepository.findBySourceQuestionIds(
  command.userId,
  command.questionBankId,
  command.selectedQuestionIds
);

// 2. Create question snapshots
const assembledQuestions = questions.map((question, index) => ({
  question_reference_id: question._id,
  source_question_id: question.source_question_id,
  display_order: index + 1,
  points_override: null,
  included_at: new Date(),
  question_snapshot: {
    question_type: question.question_type,
    title: question.title,
    content: question.content,
    points: question.points,
    status: question.status,
    mcq_data: question.mcq_data,
    essay_data: question.essay_data,
    taxonomy_snapshot: extractTaxonomySnapshot(question)
  }
}));

// 3. Calculate quiz metadata
const quizMetadata = {
  ...command.quizMetadata,
  total_points: assembledQuestions.reduce((sum, q) =>
    sum + (q.points_override || q.question_snapshot.points), 0),
  question_count: assembledQuestions.length,
  estimated_duration_minutes: command.assemblySettings.timeLimitMinutes
};
```

**Document Creation and Upsert**:
```javascript
// Create complete quiz assembly document
const quizAssemblyDocument = {
  user_id: command.userId,
  question_bank_id: command.questionBankId,
  quiz_assembly_id: command.quizAssemblyId,
  quiz_metadata: quizMetadata,
  assembled_questions: assembledQuestions,
  assembly_settings: command.assemblySettings,
  metadata: {
    created_by: command.userId,
    last_modified_by: command.userId,
    version: 1,
    assembly_source: "manual_selection"
  },
  created_at: new Date(),
  updated_at: new Date()
};

// Upsert operation
const result = await mongoTemplate.findAndModify(
  Query.query(Criteria
    .where("user_id").is(command.userId)
    .and("question_bank_id").is(command.questionBankId)
    .and("quiz_assembly_id").is(command.quizAssemblyId)
  ),
  Update.fromDocument(quizAssemblyDocument),
  FindAndModifyOptions.options().upsert(true).returnNew(true),
  "quiz_assemblies"
);
```

### Quiz Assembly Retrieval Workflow

**Query Processing**:
```javascript
// Input from GetQuizAssemblyByIdQuery
const query = {
  userId: 12345,
  questionBankId: "018f-a1b2-c3d4-e5f6-123456789abc",
  quizAssemblyId: "018f-b2c3-d4e5-f6a7-234567890def"
};

// Direct MongoDB query (no additional joins needed)
const quizAssembly = await mongoTemplate.findOne(
  Query.query(Criteria
    .where("user_id").is(query.userId)
    .and("question_bank_id").is(query.questionBankId)
    .and("quiz_assembly_id").is(query.quizAssemblyId)
    .and("archived_at").isNull()
  ),
  QuizAssemblyDocument.class,
  "quiz_assemblies"
);

// Response includes complete data from single document
const response = {
  quizAssemblyId: quizAssembly.quiz_assembly_id,
  quizMetadata: quizAssembly.quiz_metadata,
  assembledQuestions: quizAssembly.assembled_questions.map(q => ({
    sourceQuestionId: q.source_question_id,
    displayOrder: q.display_order,
    points: q.points_override || q.question_snapshot.points,
    questionSnapshot: q.question_snapshot
  })),
  assemblySettings: quizAssembly.assembly_settings,
  metadata: quizAssembly.metadata
};
```

## Performance Optimization Strategies

### 1. Question Snapshot Benefits
- **Eliminates N+1 Queries**: No need to join with questions collection for display
- **Consistent Performance**: Query time independent of question-bank collection size
- **Offline Capability**: Quiz can be displayed even if question-bank module is temporarily unavailable

### 2. Efficient Indexing
- **Compound Indexes**: Support multi-field queries without index intersection
- **Partial Indexes**: Exclude archived assemblies from active assembly indexes
- **Text Indexes**: Enable full-text search on quiz titles and descriptions

### 3. Document Size Management
- **Selective Snapshots**: Only include essential question data in snapshots
- **Compression**: MongoDB compression reduces storage overhead for repeated data
- **TTL Indexes**: Automatic cleanup of archived assemblies after retention period

### 4. Aggregation Pipeline Optimization
```javascript
// Efficient aggregation for quiz statistics
db.quiz_assemblies.aggregate([
  { $match: { user_id: 12345, question_bank_id: "018f-...", archived_at: null } },
  { $unwind: "$assembled_questions" },
  { $group: {
    _id: "$quiz_assembly_id",
    total_points: { $sum: { $ifNull: ["$assembled_questions.points_override", "$assembled_questions.question_snapshot.points"] } },
    question_count: { $sum: 1 },
    avg_difficulty: { $avg: "$assembled_questions.question_snapshot.taxonomy_snapshot.difficulty_level.numeric_value" }
  }},
  { $sort: { created_at: -1 } }
]);
```

## Scalability Considerations

### Sharding Strategy
For horizontal scaling, consider sharding on `{ user_id: "hashed" }` to:
- Distribute quiz assemblies evenly across shards
- Keep user's data co-located for efficient queries
- Support cross-shard queries for analytics when needed

### Memory Management
- **Lazy Loading**: Load question snapshots only when needed for quiz execution
- **Projection Queries**: Select only required fields for listing operations
- **Connection Pooling**: Optimize MongoDB connection usage for concurrent operations

### Monitoring Points
- **Document Size Growth**: Monitor average document size as assemblies grow
- **Index Usage**: Track index hit rates for optimization opportunities
- **Query Performance**: Monitor query execution times for large assemblies

## Schema Validation

```javascript
// MongoDB schema validation for quiz_assemblies collection
db.createCollection("quiz_assemblies", {
  validator: {
    $jsonSchema: {
      required: ["user_id", "question_bank_id", "quiz_assembly_id", "quiz_metadata", "assembled_questions", "assembly_settings", "metadata", "created_at", "updated_at"],
      properties: {
        user_id: { bsonType: "long", minimum: 1 },
        question_bank_id: { bsonType: "string", pattern: "^018f-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$" },
        quiz_assembly_id: { bsonType: "string", pattern: "^018f-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$" },
        quiz_metadata: {
          bsonType: "object",
          required: ["title", "total_points", "question_count"],
          properties: {
            title: { bsonType: "string", minLength: 1, maxLength: 200 },
            total_points: { bsonType: "int", minimum: 0 },
            question_count: { bsonType: "int", minimum: 1, maximum: 100 }
          }
        },
        assembled_questions: {
          bsonType: "array",
          minItems: 1,
          maxItems: 100,
          items: {
            bsonType: "object",
            required: ["source_question_id", "display_order", "question_snapshot"],
            properties: {
              source_question_id: { bsonType: "string", pattern: "^018f-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$" },
              display_order: { bsonType: "int", minimum: 1 },
              points_override: { bsonType: ["int", "null"], minimum: 0 }
            }
          }
        }
      }
    }
  }
});
```

This comprehensive data model provides a robust foundation for quiz assembly functionality while maintaining performance, data integrity, and seamless integration with the existing question bank system.