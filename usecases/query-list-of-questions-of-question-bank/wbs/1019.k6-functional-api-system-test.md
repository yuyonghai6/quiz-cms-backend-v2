# User Story 1019: K6 Functional API System Test (Real MongoDB Replica Set)

## Goal
Functional API system tests using K6 against a running Spring Boot app connected to a real MongoDB replica set, validating business flows and response structure using existing seeded data.

## Environment
- Spring profile: `dev` (bypasses SecurityContextValidator)
- Real MongoDB replica set: connection configured in `orchestration-layer/src/main/resources/application-dev.properties`
- Base URL: `http://localhost:8765`
- Test data (must exist in the replica set):
  - TEST_USER_ID = 1760085803933
  - TEST_QUESTION_BANK_ID = 1760085804015000

## Start/Stop Spring Boot for K6

### 1.1 Kill previous stale Spring Boot
```bash
ps aux | grep "[O]rchestrationLayerApplication" | awk '{print $2}' | xargs -r kill -9
```

### 1.2 Rebuild dependencies
```bash
mvn clean compile
```

### 1.3 Start Spring Boot with dev profile
```bash
mvn spring-boot:run -pl orchestration-layer -Dspring-boot.run.profiles=dev
```

### 1.4 Wait for application readiness (health check)
```bash
until curl -sf http://localhost:8765/actuator/health | grep -q '"status":"UP"'; do echo "waiting for app..."; sleep 2; done; echo "app is UP"
```

Notes:
- `application-dev.properties` sets the replica set URI, read preference, and disables the security context validator for development.
- Ensure the replica set and credentials are reachable from localhost.
 - You started Docker Compose MongoDB already. Verify the replica set is PRIMARY and accessible on ports configured in `application-dev.properties`.

## K6 Test Config
```javascript
const BASE_URL = 'http://localhost:8765';
const TEST_USER_ID = 1760085803933;
const TEST_QUESTION_BANK_ID = 1760085804015000;
```

## Test Artifacts to Reuse
- Functional flow reference: `api-system-test/test-upsert-question-with-taxonomy.js` (structure, checks, and HTML report generation)

## Scenarios (Functional)
- Basic query returns 200 and well-formed JSON with questions + pagination
- Category filter returns subset containing category
- Text search returns results containing all AND terms (builder enforces AND semantics)
- Combined filters (categories + tags + searchText) return consistent subset
- Sorting and pagination parameters accepted and honored

## Suggested K6 Script (functional)
Create or use `api-system-test/test-query-questions-functional.js` as a pure functional smoke test with rich checks.

- Virtual users: 1
- Iterations: 1
- No performance thresholds; all checks must pass
- Reuse HTML report generation from the reference file.

Example options:
```javascript
export const options = {
  vus: 1,
  iterations: 1,
};
```

## How to Run
- Terminal 1: start Spring Boot with dev profile (see steps above)
- Terminal 2: execute K6 functional suite

```bash
export K6_SCRIPT_PATH=api-system-test/test-query-questions-functional.js
k6 run \
  -e BASE_URL=http://localhost:8765 \
  -e USER_ID=1760085803933 \
  -e QUESTION_BANK_ID=1760085804015000 \
  "$K6_SCRIPT_PATH"
```

Optionally set `K6_SCRIPT_PATH` env for report naming:
```bash
K6_SCRIPT_PATH=api-system-test/test-query-questions-functional.js \
  k6 run -e K6_SCRIPT_PATH="$K6_SCRIPT_PATH" "$K6_SCRIPT_PATH"
```

## Reporting
- Generate HTML and JSON reports using the same reporter used in `test-upsert-question-with-taxonomy.js`.
- Reports path suggestion:
```
api-system-test/reports/test-query-questions-functional/
  ├── summary-report.html
  └── summary-data.json
```

## Acceptance Criteria
- [ ] Spring Boot starts with `dev` profile and connects to the real replica set
- [ ] Functional K6 suite executes successfully with status 200 across scenarios
- [ ] Response structure validated (questions + pagination)
- [ ] Reports generated (HTML + JSON)
- [ ] Documentation here is sufficient to run locally

## References
- Real MongoDB replica set URI: `orchestration-layer/src/main/resources/application-dev.properties`
- Existing k6 functional example: `api-system-test/test-upsert-question-with-taxonomy.js`
- k6 docs: https://k6.io/docs/

## Troubleshooting
- 401/403 responses: ensure the app runs with `-Dspring-boot.run.profiles=dev` so `security.context.validator.enabled=false` applies.
- Connection errors: confirm Mongo replica set is up and matches `application-dev.properties` host/ports and credentials.
- Slow startup: give the app 15–30 seconds on first boot; use the health check loop above to wait reliably.
- Stopping the app: you can stop via the kill command in 1.1, or use `pkill -f OrchestrationLayerApplication` on Linux.
 - Error: `text index required for $text query` (code 27)
   - Cause: full-text search scenarios require a MongoDB text index on `questions.question_text`.
   - Fix: when running with the `dev` profile, the app now auto-ensures this index at startup via a small config.
     - Source: `orchestration-layer/src/main/java/com/quizfun/orchestrationlayer/configuration/MongoTextIndexConfig.java`
     - It creates a text index on the `questions` collection's `question_text` field.
   - If you don't need text search temporarily, comment out the searchText scenarios in the K6 script.

## Notes on full-text index (dev profile)
- With the `dev` profile, the app ensures a text index on `question_text` in the `questions` collection at startup.
- This is safe and idempotent on dev environments and prevents `$text` query errors during functional tests.
- Production indexing should be managed via migrations/infra-as-code; this auto-index is intentionally scoped to `dev` only.
