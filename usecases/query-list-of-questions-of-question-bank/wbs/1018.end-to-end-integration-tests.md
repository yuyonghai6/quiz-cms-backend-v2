# User Story 1018: End-to-End Integration Tests (RestTemplate + Testcontainers)

## User Story

**As a** QA engineer
**I want** comprehensive end-to-end integration tests for the query questions API using RestTemplate and Testcontainers
**So that** I can ensure the entire system works correctly from HTTP request to database query in an isolated test environment

## Acceptance Criteria

- [ ] E2E test verifies complete flow from HTTP request to database query
- [ ] E2E test covers all major scenarios (basic query, filters, search, pagination)
- [ ] E2E test uses TestRestTemplate with real Spring Boot context
- [ ] E2E test uses Testcontainers for isolated MongoDB
- [ ] Allure annotations correctly applied
- [ ] Text index created for MongoDB text search functionality (in the test lifecycle)
- [ ] This user story excludes K6; K6 has been moved to 1019/1020

## Related User Stories

- 1019: K6 Functional API System Tests (with real MongoDB replica set)
- 1020: K6 Performance Tests (load testing with real infrastructure)

Note: K6 content previously drafted here has been moved to the dedicated WBS files above. This file is kept strictly for RestTemplate-based E2E tests backed by Testcontainers MongoDB.

---

## TDD Cycle

### Allure Annotations Format

```java
@Epic("Use Case Query List of Questions of Question Bank")
@Story("1018.end-to-end-integration-tests")
```

---

## Phase 1: RED (Write Failing Tests)

### Objective
Write failing E2E tests that verify the complete system.

### Tasks

#### Task 1.1: Create Comprehensive E2E Test

**File**: `orchestration-layer/src/test/java/com/quizfun/orchestrationlayer/e2e/QueryQuestionsE2ETest.java`

```java
package com.quizfun.orchestrationlayer.e2e;

import com.quizfun.questionbankquery.infrastructure.persistence.documents.QuestionDocument;
import com.quizfun.questionbankquery.infrastructure.persistence.documents.TaxonomyDocument;
import io.qameta.allure.Epic;
import io.qameta.allure.Story;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.testcontainers.containers.MongoDBContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.time.Instant;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

@Epic("Use Case Query List of Questions of Question Bank")
@Story("1018.end-to-end-integration-tests")
@Testcontainers
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@DisplayName("Query Questions End-to-End Tests")
class QueryQuestionsE2ETest {

    @Container
    static MongoDBContainer mongoContainer = new MongoDBContainer("mongo:8.0")
            .withExposedPorts(27017)
            .withReuse(false);

    @DynamicPropertySource
    static void mongoProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.data.mongodb.uri", mongoContainer::getReplicaSetUrl);
        registry.add("spring.data.mongodb.read-preference", () -> "primary");
    }

    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private MongoTemplate mongoTemplate;

    private static final Long TEST_USER_ID = 12345L;
    private static final Long TEST_QUESTION_BANK_ID = 67890L;
    private static final String COLLECTION_NAME = "questions";

    private String baseUrl;

    @BeforeEach
    void setUp() {
        baseUrl = "http://localhost:" + port + "/api/v1/users/" + TEST_USER_ID
                + "/question-banks/" + TEST_QUESTION_BANK_ID + "/questions";

        mongoTemplate.dropCollection(COLLECTION_NAME);
        mongoTemplate.createCollection(COLLECTION_NAME);
        insertTestQuestions();
    }

    @AfterEach
    void tearDown() {
        mongoTemplate.dropCollection(COLLECTION_NAME);
    }

    @Test
    @DisplayName("E2E: Should query questions with basic pagination")
    void shouldQueryQuestionsWithBasicPagination() {
        // WHEN: Making HTTP GET request
        String url = baseUrl + "?page=0&size=10";
        ResponseEntity<Map> response = restTemplate.getForEntity(url, Map.class);

        // THEN: Should return 200 OK
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();

        // AND: Should have questions
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> questions = (List<Map<String, Object>>) response.getBody().get("questions");
        assertThat(questions).hasSize(10);

        // AND: Should have pagination metadata
        @SuppressWarnings("unchecked")
        Map<String, Object> pagination = (Map<String, Object>) response.getBody().get("pagination");
        assertThat(pagination.get("currentPage")).isEqualTo(0);
        assertThat(pagination.get("pageSize")).isEqualTo(10);
        assertThat(pagination.get("totalItems")).isEqualTo(50);
        assertThat(pagination.get("totalPages")).isEqualTo(5);
    }

    @Test
    @DisplayName("E2E: Should query questions with category filter")
    void shouldQueryQuestionsWithCategoryFilter() {
        // WHEN: Filtering by category
        String url = baseUrl + "?categories=Math&page=0&size=20";
        ResponseEntity<Map> response = restTemplate.getForEntity(url, Map.class);

        // THEN: Should return filtered results
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);

        @SuppressWarnings("unchecked")
        List<Map<String, Object>> questions = (List<Map<String, Object>>) response.getBody().get("questions");
        assertThat(questions).hasSize(20);

        // Verify first question has Math category
        @SuppressWarnings("unchecked")
        Map<String, Object> firstQuestion = questions.get(0);
        @SuppressWarnings("unchecked")
        Map<String, Object> taxonomy = (Map<String, Object>) firstQuestion.get("taxonomy");
        @SuppressWarnings("unchecked")
        List<String> categories = (List<String>) taxonomy.get("categories");
        assertThat(categories).contains("Math");
    }

    @Test
    @DisplayName("E2E: Should query questions with text search")
    void shouldQueryQuestionsWithTextSearch() {
        // WHEN: Searching by text
        String url = baseUrl + "?searchText=equation&page=0&size=10";
        ResponseEntity<Map> response = restTemplate.getForEntity(url, Map.class);

        // THEN: Should return matching results
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);

        @SuppressWarnings("unchecked")
        List<Map<String, Object>> questions = (List<Map<String, Object>>) response.getBody().get("questions");
        assertThat(questions).isNotEmpty();

        // Verify question text contains search term
        String questionText = (String) questions.get(0).get("questionText");
        assertThat(questionText.toLowerCase()).contains("equation");
    }

    @Test
    @DisplayName("E2E: Should query questions with combined filters")
    void shouldQueryQuestionsWithCombinedFilters() {
        // WHEN: Combining multiple filters
        String url = baseUrl + "?categories=Math&tags=algebra&searchText=equation&page=0&size=10";
        ResponseEntity<Map> response = restTemplate.getForEntity(url, Map.class);

        // THEN: Should return results matching all filters
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);

        @SuppressWarnings("unchecked")
        List<Map<String, Object>> questions = (List<Map<String, Object>>) response.getBody().get("questions");
        assertThat(questions).isNotEmpty();
    }

    @Test
    @DisplayName("E2E: Should handle pagination across multiple pages")
    void shouldHandlePaginationAcrossMultiplePages() {
        // WHEN: Querying multiple pages
        String url1 = baseUrl + "?page=0&size=10";
        String url2 = baseUrl + "?page=1&size=10";
        String url3 = baseUrl + "?page=4&size=10";

        ResponseEntity<Map> response1 = restTemplate.getForEntity(url1, Map.class);
        ResponseEntity<Map> response2 = restTemplate.getForEntity(url2, Map.class);
        ResponseEntity<Map> response3 = restTemplate.getForEntity(url3, Map.class);

        // THEN: All pages should return successfully
        assertThat(response1.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response2.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response3.getStatusCode()).isEqualTo(HttpStatus.OK);

        // AND: Pages should have correct sizes
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> page1 = (List<Map<String, Object>>) response1.getBody().get("questions");
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> page2 = (List<Map<String, Object>>) response2.getBody().get("questions");
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> page3 = (List<Map<String, Object>>) response3.getBody().get("questions");

        assertThat(page1).hasSize(10);
        assertThat(page2).hasSize(10);
        assertThat(page3).isEmpty(); // Last page beyond total items
    }

    @Test
    @DisplayName("E2E: Should return empty list for non-existent user")
    void shouldReturnEmptyListForNonExistentUser() {
        // WHEN: Querying with non-existent user
        String url = "http://localhost:" + port + "/api/v1/users/99999/question-banks/"
                + TEST_QUESTION_BANK_ID + "/questions?page=0&size=10";
        ResponseEntity<Map> response = restTemplate.getForEntity(url, Map.class);

        // THEN: Should return 200 OK with empty list
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);

        @SuppressWarnings("unchecked")
        List<Map<String, Object>> questions = (List<Map<String, Object>>) response.getBody().get("questions");
        assertThat(questions).isEmpty();

        @SuppressWarnings("unchecked")
        Map<String, Object> pagination = (Map<String, Object>) response.getBody().get("pagination");
        assertThat(pagination.get("totalItems")).isEqualTo(0);
    }

    @Test
    @DisplayName("E2E: Should return 400 for invalid page number")
    void shouldReturn400ForInvalidPageNumber() {
        // WHEN: Using invalid page number
        String url = baseUrl + "?page=-1&size=10";
        ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);

        // THEN: Should return 400 BAD REQUEST
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
    }

    @Test
    @DisplayName("E2E: Should verify complete response structure")
    void shouldVerifyCompleteResponseStructure() {
        // WHEN: Making request
        String url = baseUrl + "?page=0&size=1";
        ResponseEntity<Map> response = restTemplate.getForEntity(url, Map.class);

        // THEN: Should have complete structure
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        Map<String, Object> body = response.getBody();
        assertThat(body).containsKeys("questions", "pagination");

        @SuppressWarnings("unchecked")
        List<Map<String, Object>> questions = (List<Map<String, Object>>) body.get("questions");
        assertThat(questions).hasSize(1);

        Map<String, Object> question = questions.get(0);
        assertThat(question).containsKeys(
                "questionId", "questionText", "questionType",
                "difficultyLevel", "taxonomy", "createdAt", "updatedAt"
        );

        @SuppressWarnings("unchecked")
        Map<String, Object> taxonomy = (Map<String, Object>) question.get("taxonomy");
        assertThat(taxonomy).containsKeys("categories", "tags", "quizzes");

        @SuppressWarnings("unchecked")
        Map<String, Object> pagination = (Map<String, Object>) body.get("pagination");
        assertThat(pagination).containsKeys(
                "currentPage", "pageSize", "totalItems", "totalPages"
        );
    }

    // Helper method

    private void insertTestQuestions() {
        Instant now = Instant.now();
        for (int i = 0; i < 50; i++) {
            TaxonomyDocument taxonomy = TaxonomyDocument.builder()
                    .categories(List.of("Math", "Algebra"))
                    .tags(List.of("algebra", "equations"))
                    .quizzes(List.of("midterm-2024"))
                    .build();

            QuestionDocument doc = QuestionDocument.builder()
                    .questionId(6000000000000L + i)
                    .userId(TEST_USER_ID)
                    .questionBankId(TEST_QUESTION_BANK_ID)
                    .questionText("Solve the equation for x: " + i)
                    .questionType("MCQ")
                    .difficultyLevel("EASY")
                    .taxonomy(taxonomy)
                    .createdAt(now.minusSeconds(100 - i))
                    .updatedAt(now.minusSeconds(100 - i))
                    .build();

            mongoTemplate.insert(doc, COLLECTION_NAME);
        }
    }
}
```

#### Task 1.2: Run E2E Tests (Should PASS if previous user stories complete)

```bash
mvn clean test -pl orchestration-layer -Dtest=QueryQuestionsE2ETest
```

**Expected Result**: All 8 E2E tests should PASS (system is already implemented).

---

## Definition of Done

- [ ] E2E tests created and passing (8 tests)
- [ ] E2E tests cover major scenarios
- [ ] Tests wired with Testcontainers MongoDB
- [ ] Allure report annotations present
- [ ] JaCoCo coverage maintained (tracked at module level)

## Notes

- K6 functional and performance testing are documented separately:
  - See 1019.k6-functional-api-system-test.md
  - See 1020.k6-performance-test.md

## Summary

This user story focuses purely on RestTemplate-based E2E tests backed by Testcontainers MongoDB. K6-based testing has been split into dedicated work items to keep responsibilities clear and environments separate.
