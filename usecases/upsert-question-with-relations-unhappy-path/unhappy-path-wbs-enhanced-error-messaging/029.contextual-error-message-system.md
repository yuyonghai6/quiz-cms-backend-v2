# US-029: Contextual Error Message System

## User Story
**As a** API consumer integrating quiz creation functionality
**I want** contextual error messages that include relevant state information and user guidance
**So that** validation failures can be resolved efficiently with proper context understanding

## Epic
Enhanced Error Messaging

## Story
Implement comprehensive contextual error messaging system that provides relevant state information, user guidance, and integration context for validation failures

## Acceptance Criteria

### Contextual Information Enhancement
- [ ] **AC-029.1**: Error messages must include relevant question bank context (name, owner, permissions)
- [ ] **AC-029.2**: Validation errors must reference related entities when applicable (existing questions, categories)
- [ ] **AC-029.3**: Error context must include user session information for debugging (user ID, timestamp, operation context)
- [ ] **AC-029.4**: System state information must be included when relevant to error resolution

### User Guidance Integration
- [ ] **AC-029.5**: Error messages must include step-by-step guidance for common validation failures
- [ ] **AC-029.6**: Related documentation links must be provided for complex validation scenarios
- [ ] **AC-029.7**: Example payloads must be included for format-related validation errors
- [ ] **AC-029.8**: Contextual help must adapt based on user's historical interaction patterns

### Integration Context
- [ ] **AC-029.9**: Error messages must reference integration points with existing US-003-007 components
- [ ] **AC-029.10**: Validation chain context must be preserved and communicated in error responses
- [ ] **AC-029.11**: Cross-component error correlation must be maintained for debugging
- [ ] **AC-029.12**: Request tracing information must be included for distributed error tracking

## Technical Requirements

### Contextual Error Builder
```java
@Component
public class ContextualErrorMessageBuilder {

    private final QuestionBankRepository questionBankRepository; // From US-005
    private final UserContextService userContextService;
    private final ValidationChainMetrics validationMetrics; // From US-003
    private final ErrorContextCollector contextCollector;

    public DetailedErrorResponse buildContextualError(
            ValidationError error,
            UpsertQuestionCommand command,
            ValidationContext validationContext) {

        var contextBuilder = DetailedErrorContext.builder()
            .errorCode(error.getErrorCode())
            .message(error.getMessage())
            .timestamp(LocalDateTime.now())
            .requestId(validationContext.getRequestId());

        // 1. Add question bank context
        addQuestionBankContext(contextBuilder, command);

        // 2. Add user operation context
        addUserOperationContext(contextBuilder, command, validationContext);

        // 3. Add validation chain context
        addValidationChainContext(contextBuilder, validationContext);

        // 4. Add guidance and documentation
        addUserGuidance(contextBuilder, error);

        // 5. Add related entity context
        addRelatedEntityContext(contextBuilder, command);

        return DetailedErrorResponse.builder()
            .success(false)
            .error(contextBuilder.build())
            .suggestions(generateContextualSuggestions(error, command))
            .relatedDocumentation(getRelatedDocumentation(error))
            .build();
    }

    private void addQuestionBankContext(DetailedErrorContext.Builder builder, UpsertQuestionCommand command) {
        try {
            var questionBank = questionBankRepository.findById(command.getQuestionBankId());
            if (questionBank.isPresent()) {
                builder.questionBankContext(QuestionBankContext.builder()
                    .id(questionBank.get().getId())
                    .name(questionBank.get().getName())
                    .ownerUserId(questionBank.get().getOwnerUserId())
                    .questionCount(questionBank.get().getQuestions().size())
                    .categories(extractCategories(questionBank.get()))
                    .build());
            }
        } catch (Exception ex) {
            // Don't fail error response generation due to context collection failure
            builder.contextCollectionNote("Question bank context unavailable: " + ex.getMessage());
        }
    }

    private void addUserOperationContext(
            DetailedErrorContext.Builder builder,
            UpsertQuestionCommand command,
            ValidationContext context) {

        builder.userOperationContext(UserOperationContext.builder()
            .userId(command.getUserId())
            .operationType(determineOperationType(command))
            .requestTimestamp(context.getRequestTimestamp())
            .validationAttemptNumber(context.getAttemptNumber())
            .previousValidationFailures(context.getPreviousFailures())
            .build());
    }

    private void addValidationChainContext(
            DetailedErrorContext.Builder builder,
            ValidationContext context) {

        builder.validationChainContext(ValidationChainContext.builder()
            .completedValidators(context.getCompletedValidators())
            .failedValidator(context.getFailedValidator())
            .validationMetrics(validationMetrics.getCurrentMetrics())
            .chainExecutionTime(context.getExecutionTime())
            .build());
    }
}
```

### Enhanced Error Response Structure
```java
@Value
@Builder
public class DetailedErrorResponse {
    boolean success;
    DetailedErrorContext error;
    List<ContextualSuggestion> suggestions;
    List<DocumentationReference> relatedDocumentation;
    Map<String, Object> debugContext;

    @Value
    @Builder
    public static class DetailedErrorContext {
        String errorCode;
        String message;
        LocalDateTime timestamp;
        String requestId;
        QuestionBankContext questionBankContext;
        UserOperationContext userOperationContext;
        ValidationChainContext validationChainContext;
        List<RelatedEntityReference> relatedEntities;
        String contextCollectionNote;
    }

    @Value
    @Builder
    public static class ContextualSuggestion {
        String title;
        String description;
        List<String> steps;
        String category; // "IMMEDIATE", "NEXT_STEPS", "BEST_PRACTICES"
        ExamplePayload examplePayload;
        List<String> relatedErrorCodes;
    }

    @Value
    @Builder
    public static class DocumentationReference {
        String title;
        String url;
        String description;
        String relevanceReason;
    }
}
```

### Contextual Suggestion Generator
```java
@Component
public class ContextualSuggestionGenerator {

    private final Map<String, SuggestionStrategy> suggestionStrategies;
    private final DocumentationService documentationService;
    private final ExamplePayloadGenerator exampleGenerator;

    public List<ContextualSuggestion> generateSuggestions(
            ValidationError error,
            UpsertQuestionCommand command,
            DetailedErrorContext context) {

        var suggestions = new ArrayList<ContextualSuggestion>();

        // 1. Get error-specific suggestions
        var strategy = suggestionStrategies.get(error.getErrorCode());
        if (strategy != null) {
            suggestions.addAll(strategy.generateSuggestions(error, command, context));
        }

        // 2. Add contextual suggestions based on user history
        suggestions.addAll(generateHistoryBasedSuggestions(context.getUserOperationContext()));

        // 3. Add question type specific suggestions
        suggestions.addAll(generateQuestionTypeSpecificSuggestions(command));

        // 4. Add integration-specific suggestions
        suggestions.addAll(generateIntegrationSuggestions(context));

        return suggestions.stream()
            .sorted(Comparator.comparing(s -> s.getCategory()))
            .collect(Collectors.toList());
    }

    private List<ContextualSuggestion> generateQuestionTypeSpecificSuggestions(UpsertQuestionCommand command) {
        var questionType = command.getQuestion().getType();
        var suggestions = new ArrayList<ContextualSuggestion>();

        switch (questionType) {
            case MULTIPLE_CHOICE:
                suggestions.add(ContextualSuggestion.builder()
                    .title("Multiple Choice Question Requirements")
                    .description("Ensure your multiple choice question meets all requirements")
                    .category("IMMEDIATE")
                    .steps(Arrays.asList(
                        "Provide at least 2 answer options",
                        "Mark at least 1 correct answer",
                        "Ensure option text is between 1-500 characters",
                        "Make sure correct answer indices match available options"
                    ))
                    .examplePayload(exampleGenerator.generateMultipleChoiceExample())
                    .build());
                break;
            case TRUE_FALSE:
                suggestions.add(ContextualSuggestion.builder()
                    .title("True/False Question Setup")
                    .description("Configure your true/false question correctly")
                    .category("IMMEDIATE")
                    .steps(Arrays.asList(
                        "Set correctAnswer to either 'true' or 'false'",
                        "Provide clear question text",
                        "Consider adding explanation for the correct answer"
                    ))
                    .examplePayload(exampleGenerator.generateTrueFalseExample())
                    .build());
                break;
        }

        return suggestions;
    }
}
```

### Integration Points
- **US-003**: Uses ValidationHandler context and ValidationChainMetrics
- **US-005**: Leverages repository layer for contextual entity information
- **US-028**: Builds upon enhanced validation error structure

## Business Rules

### Context Collection Rules
1. **Non-Blocking**: Context collection failures must not prevent error response generation
2. **Privacy-Aware**: User context must respect privacy and security requirements
3. **Performance-Conscious**: Context collection must not significantly impact error response time
4. **Relevant-Only**: Only contextually relevant information included in error responses

### Guidance Standards
1. **Actionable**: All guidance must provide specific, actionable steps
2. **Progressive**: Guidance complexity adapts to user experience level
3. **Complete**: Error resolution paths must be complete and testable
4. **Documented**: All suggestions must link to comprehensive documentation

### Integration Context Rules
1. **Component-Aware**: Error context must include relevant component interaction information
2. **Traceable**: Request tracing must support distributed debugging
3. **Correlatable**: Related errors across components must be correlatable
4. **Versioned**: Context information must include component version compatibility data

## Definition of Done

### Contextual Error System
- [ ] ContextualErrorMessageBuilder implemented with comprehensive context collection
- [ ] DetailedErrorResponse structure supporting rich contextual information
- [ ] Context collection with non-blocking failure handling for resilience
- [ ] Integration with existing US-003 ValidationHandler and US-005 repository patterns

### Suggestion System
- [ ] ContextualSuggestionGenerator with error-specific and context-aware suggestions
- [ ] Question type specific guidance with examples and step-by-step instructions
- [ ] User history-based suggestion adaptation for improved user experience
- [ ] Documentation integration with relevant links and references

### Integration Complete
- [ ] Error context includes validation chain execution information from US-003
- [ ] Question bank and related entity context from US-005 repository layer
- [ ] Enhanced error messages integrate with US-028 type-specific validation
- [ ] Cross-component error correlation for distributed debugging

### Response Quality
- [ ] Error responses provide sufficient context for efficient problem resolution
- [ ] Suggestion quality verified through developer user testing
- [ ] Documentation integration tested for accuracy and relevance
- [ ] Performance impact of context collection verified <100ms per error

## Dependencies

### Prerequisites
- **US-028**: Type-specific validation error enhancement for error classification
- **US-003**: ValidationHandler pattern and ValidationChainMetrics
- **US-005**: Repository layer for entity context collection
- **US-007**: QuestionApplicationService for operation context

### External Dependencies
- Documentation management system for dynamic documentation linking
- Request tracing infrastructure for distributed error correlation
- User analytics system for history-based suggestion generation

## Risk Mitigation

### Performance Risks
- **Context Collection Overhead**: Asynchronous context collection with timeout protection
- **Error Response Size**: Bounded context information with configurable detail levels
- **Documentation Lookup**: Cached documentation references with fallback handling
- **Database Queries**: Optimized context queries with circuit breaker pattern

### Privacy and Security Risks
- **Sensitive Information Exposure**: Context filtering to prevent sensitive data inclusion
- **User Privacy**: Anonymized user context data with consent-based detailed context
- **Cross-User Information Leakage**: Strict user context isolation and validation
- **Debug Information Security**: Production-safe debug context with sensitive data masking

### Integration Risks
- **Context Collection Failures**: Non-blocking context collection with graceful degradation
- **Component Availability**: Resilient context collection with service availability handling
- **Documentation Accuracy**: Automated documentation link validation and updates
- **Version Compatibility**: Context information versioning for component compatibility

## Success Metrics

### Context Quality
- Error resolution success rate improved by 40% with contextual information
- Average time to error resolution reduced by 50% with enhanced context
- Developer satisfaction score >90% for error context helpfulness
- Context collection success rate >95% under normal operating conditions

### User Experience
- API consumer onboarding error resolution time reduced by 60%
- Support ticket volume for validation errors reduced by 50%
- Self-service error resolution rate increased by 70%
- Error message actionability score >95% based on developer feedback

### System Integration
- Context collection performance impact <100ms per error response
- Non-blocking context collection success rate 100% (no error response failures)
- Cross-component error correlation accuracy >95%
- Documentation link accuracy maintained >98%