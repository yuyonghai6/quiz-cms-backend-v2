# POST Generate Quiz Assembly - API Documentation

## Endpoint Overview

**Endpoint**: `POST /api/users/{userId}/questionbanks/{questionbankId}/quiz-assemblies`

**Purpose**: Create or update a quiz assembly by aggregating selected questions from a question bank

**Authentication**: Required (JWT token)

**Authorization**: User can only create quiz assemblies within their own question banks

**Operation Type**: Upsert (Insert if new, Update if exists)

## Request Specification

### HTTP Method
```
POST
```

### URL Structure
```
/api/users/{userId}/questionbanks/{questionbankId}/quiz-assemblies
```

### Path Parameters

| Parameter | Type | Format | Required | Description |
|-----------|------|--------|----------|-------------|
| `userId` | Long | Numeric | Yes | Unique identifier of the user |
| `questionbankId` | String | UUID v7 | Yes | Unique identifier of the question bank |

#### Parameter Validation Rules

**userId**:
- Must be a positive Long value
- Must match the authenticated user's ID
- Example: `12345`

**questionbankId**:
- Must be a valid UUID v7 format
- Format: `018f-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- Must belong to the specified user
- Example: `018f-a1b2-c3d4-e5f6-123456789abc`

### Headers

| Header | Value | Required | Description |
|--------|-------|----------|-------------|
| `Authorization` | `Bearer {jwt_token}` | Yes | JWT authentication token |
| `Content-Type` | `application/json` | Yes | Request body content type |
| `Accept` | `application/json` | No | Response content type (default) |

### Request Body

**Content-Type**: `application/json`

**Request Structure**:
```json
{
  "quiz_assembly_id": "string",
  "quiz_metadata": "object",
  "selected_question_ids": "array",
  "assembly_settings": "object",
  "question_display_orders": "object",
  "points_overrides": "object",
  "assembly_metadata": "object"
}
```

#### Request Field Descriptions

**quiz_assembly_id** (String, Required):
- Unique identifier for the quiz assembly
- Must be valid UUID v7 format
- Used for upsert operations (insert if new, update if exists)
- Example: `"018f-b2c3-d4e5-f6a7-234567890def"`

**quiz_metadata** (Object, Required):
```json
{
  "title": "string",                         // Required, 1-200 characters
  "description": "string",                   // Optional, max 1000 characters
  "estimated_duration_minutes": "number"     // Optional, 1-600 minutes
}
```

**selected_question_ids** (Array, Required):
- Array of question source IDs to include in assembly
- Each ID must be valid UUID v7 format
- Minimum 1 question, maximum 100 questions
- All questions must exist in the specified question bank
- Example: `["018f-c3d4-e5f6-a7b8-345678901234", "018f-d4e5-f6a7-b8c9-456789012345"]`

**assembly_settings** (Object, Optional):
```json
{
  "randomize_question_order": "boolean",      // Default: false
  "allow_navigation": "boolean",              // Default: true
  "allow_review": "boolean",                  // Default: true
  "time_limit_minutes": "number",             // Default: null (no limit)
  "auto_submit_on_timeout": "boolean",        // Default: false
  "show_progress_indicator": "boolean",       // Default: true
  "allow_question_skipping": "boolean",       // Default: true
  "require_all_questions_attempted": "boolean" // Default: false
}
```

**question_display_orders** (Object, Optional):
- Maps question IDs to their display order in the quiz
- If not provided, questions are ordered by array sequence
- Values must be positive integers and unique
- Example: `{"018f-c3d4-e5f6-a7b8-345678901234": 1, "018f-d4e5-f6a7-b8c9-456789012345": 2}`

**points_overrides** (Object, Optional):
- Maps question IDs to custom point values
- Overrides the original question points for this assembly
- Values must be positive integers
- Example: `{"018f-d4e5-f6a7-b8c9-456789012345": 8}`

**assembly_metadata** (Object, Optional):
```json
{
  "assembly_source": "string",               // Default: "manual_selection"
  "is_template": "boolean",                  // Default: false
  "template_category": "string",             // Optional, required if is_template=true
  "learning_objectives": "array",            // Array of strings
  "target_audience": "string",               // "beginner", "intermediate", "advanced"
  "difficulty_balance": {                    // Optional difficulty distribution
    "easy_percentage": "number",             // 0-100
    "medium_percentage": "number",           // 0-100
    "hard_percentage": "number"              // 0-100 (must sum to 100 if provided)
  }
}
```

#### Complete Request Example
See `5.1.generate_quiz_assembly.json` for a comprehensive request example.

### Request Validation Rules

#### Business Rules Validation
1. **User Ownership**: User must own the specified question bank
2. **Question Existence**: All selected question IDs must exist in the question bank
3. **Question Status**: All selected questions must be in 'published' status
4. **Unique Assembly ID**: Quiz assembly ID must be unique within user's question bank (for new assemblies)
5. **Display Order Uniqueness**: All display order values must be unique
6. **Points Override Validation**: Points override values must be positive integers

#### Data Validation Rules
1. **UUID Format**: All UUID fields must be valid UUID v7 format
2. **String Length**: Title (1-200 chars), Description (max 1000 chars)
3. **Numeric Ranges**: Duration (1-600 minutes), Points (positive integers)
4. **Array Limits**: Minimum 1 question, maximum 100 questions
5. **Percentage Validation**: Difficulty percentages must sum to 100 if provided

## Response Specification

### Success Response (HTTP 200 - Update) / (HTTP 201 - Create)

**Content-Type**: `application/json`

**Response Structure**:
```json
{
  "success": true,
  "data": {
    "quiz_assembly_id": "string",
    "user_id": "number",
    "question_bank_id": "string",
    "quiz_metadata": "object",
    "assembled_questions": "array",
    "assembly_settings": "object",
    "metadata": "object",
    "statistics": "object",
    "created_at": "string",
    "updated_at": "string",
    "operation_type": "string"
  },
  "error": null
}
```

#### Response Field Descriptions

**operation_type** (String):
- Indicates whether the operation was a creation or update
- Values: `"created"` or `"updated"`

**quiz_metadata** (Object):
```json
{
  "title": "string",
  "description": "string",
  "total_points": "number",                   // Calculated from questions
  "estimated_duration_minutes": "number",
  "question_count": "number",                 // Calculated from selected questions
  "difficulty_distribution": {
    "easy": "number",                         // Count of easy questions
    "medium": "number",                       // Count of medium questions
    "hard": "number"                          // Count of hard questions
  }
}
```

**assembled_questions** (Array):
- Simplified view of questions included in assembly
- Each question includes essential information without full snapshots
```json
[
  {
    "source_question_id": "string",
    "display_order": "number",
    "points": "number",                       // Effective points (including overrides)
    "question_type": "string",
    "title": "string",
    "difficulty_level": "string"
  }
]
```

**statistics** (Object):
```json
{
  "average_time_per_question": "number",      // Estimated minutes
  "complexity_score": "number",               // 1-5 scale
  "topic_coverage": [
    {
      "topic": "string",
      "question_count": "number"
    }
  ]
}
```

#### Success Response Example
```json
{
  "success": true,
  "data": {
    "quiz_assembly_id": "018f-b2c3-d4e5-f6a7-234567890def",
    "user_id": 12345,
    "question_bank_id": "018f-a1b2-c3d4-e5f6-123456789abc",
    "quiz_metadata": {
      "title": "JavaScript Fundamentals Assessment",
      "description": "Comprehensive evaluation covering variables, functions, arrays, and objects",
      "total_points": 95,
      "estimated_duration_minutes": 75,
      "question_count": 15,
      "difficulty_distribution": {
        "easy": 6,
        "medium": 7,
        "hard": 2
      }
    },
    "assembled_questions": [
      {
        "source_question_id": "018f-c3d4-e5f6-a7b8-345678901234",
        "display_order": 1,
        "points": 5,
        "question_type": "mcq",
        "title": "JavaScript Variable Declaration",
        "difficulty_level": "easy"
      }
    ],
    "assembly_settings": {
      "randomize_question_order": false,
      "allow_navigation": true,
      "time_limit_minutes": 75
    },
    "metadata": {
      "created_by": 12345,
      "version": 1,
      "assembly_source": "manual_selection"
    },
    "statistics": {
      "average_time_per_question": 5.0,
      "complexity_score": 2.3
    },
    "created_at": "2025-09-29T10:30:00Z",
    "updated_at": "2025-09-29T10:30:00Z",
    "operation_type": "created"
  },
  "error": null
}
```

### Error Responses

#### 400 Bad Request
**Scenario**: Invalid request data or validation failures

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": {
      "field_errors": [
        {
          "field": "selected_question_ids",
          "message": "Questions not found in question bank",
          "invalid_values": [
            "018f-xxxx-yyyy-zzzz-invalid123456"
          ]
        },
        {
          "field": "quiz_metadata.title",
          "message": "Title is required and must be 1-200 characters",
          "provided_value": ""
        }
      ],
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

#### 401 Unauthorized
**Scenario**: Missing or invalid authentication token

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required",
    "details": {
      "reason": "Missing or invalid JWT token",
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

#### 403 Forbidden
**Scenario**: User doesn't own the question bank

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "FORBIDDEN",
    "message": "Access denied to question bank",
    "details": {
      "reason": "User does not own the specified question bank",
      "user_id": 12345,
      "question_bank_id": "018f-a1b2-c3d4-e5f6-123456789abc",
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

#### 409 Conflict
**Scenario**: Quiz assembly ID already exists (for creation operations)

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "CONFLICT",
    "message": "Quiz assembly already exists",
    "details": {
      "quiz_assembly_id": "018f-b2c3-d4e5-f6a7-234567890def",
      "existing_version": 2,
      "suggestion": "Use PUT for updates or generate a new quiz_assembly_id",
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

#### 422 Unprocessable Entity
**Scenario**: Business rule violations

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "BUSINESS_RULE_VIOLATION",
    "message": "Selected questions violate business rules",
    "details": {
      "violations": [
        {
          "rule": "question_status_published",
          "message": "All questions must be in published status",
          "affected_questions": [
            "018f-c3d4-e5f6-a7b8-345678901234"
          ]
        },
        {
          "rule": "display_order_unique",
          "message": "Display order values must be unique",
          "duplicate_orders": [1, 1]
        }
      ],
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

#### 500 Internal Server Error
**Scenario**: Database connection failure or unexpected system error

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "Service temporarily unavailable",
    "details": {
      "reason": "Database operation failed",
      "retry_after": "5 minutes",
      "request_id": "req_12345678-1234-5678-9012-123456789abc",
      "timestamp": "2025-09-29T10:30:00Z"
    }
  }
}
```

## Usage Examples

### Create New Quiz Assembly

**Request**:
```http
POST /api/users/12345/questionbanks/018f-a1b2-c3d4-e5f6-123456789abc/quiz-assemblies HTTP/1.1
Host: quiz-cms-api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "quiz_assembly_id": "018f-b2c3-d4e5-f6a7-234567890def",
  "quiz_metadata": {
    "title": "JavaScript Basics Quiz",
    "description": "Test your understanding of JavaScript fundamentals",
    "estimated_duration_minutes": 30
  },
  "selected_question_ids": [
    "018f-c3d4-e5f6-a7b8-345678901234",
    "018f-d4e5-f6a7-b8c9-456789012345"
  ],
  "assembly_settings": {
    "time_limit_minutes": 30,
    "allow_review": true
  }
}
```

**Response**:
```http
HTTP/1.1 201 Created
Content-Type: application/json
Location: /api/users/12345/questionbanks/018f-a1b2-c3d4-e5f6-123456789abc/quiz-assemblies/018f-b2c3-d4e5-f6a7-234567890def

{
  "success": true,
  "data": {
    "quiz_assembly_id": "018f-b2c3-d4e5-f6a7-234567890def",
    "operation_type": "created",
    // ... complete response data
  },
  "error": null
}
```

### Update Existing Quiz Assembly

**Request**:
```http
POST /api/users/12345/questionbanks/018f-a1b2-c3d4-e5f6-123456789abc/quiz-assemblies HTTP/1.1
Host: quiz-cms-api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "quiz_assembly_id": "018f-b2c3-d4e5-f6a7-234567890def",
  "quiz_metadata": {
    "title": "JavaScript Basics Quiz - Updated",
    "description": "Enhanced test with additional questions",
    "estimated_duration_minutes": 45
  },
  "selected_question_ids": [
    "018f-c3d4-e5f6-a7b8-345678901234",
    "018f-d4e5-f6a7-b8c9-456789012345",
    "018f-e5f6-a7b8-c9d0-567890123456"
  ]
}
```

**Response**:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "data": {
    "quiz_assembly_id": "018f-b2c3-d4e5-f6a7-234567890def",
    "operation_type": "updated",
    // ... complete response data
  },
  "error": null
}
```

### Advanced Quiz Assembly with Custom Settings

**Request**:
```http
POST /api/users/12345/questionbanks/018f-a1b2-c3d4-e5f6-123456789abc/quiz-assemblies HTTP/1.1
Host: quiz-cms-api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "quiz_assembly_id": "018f-advanced-quiz-assembly-id",
  "quiz_metadata": {
    "title": "Advanced JavaScript Assessment",
    "description": "Comprehensive evaluation for experienced developers",
    "estimated_duration_minutes": 120
  },
  "selected_question_ids": [
    "018f-question-id-1", "018f-question-id-2", "018f-question-id-3"
  ],
  "assembly_settings": {
    "randomize_question_order": true,
    "allow_navigation": false,
    "time_limit_minutes": 120,
    "auto_submit_on_timeout": true,
    "require_all_questions_attempted": true
  },
  "question_display_orders": {
    "018f-question-id-1": 1,
    "018f-question-id-2": 2,
    "018f-question-id-3": 3
  },
  "points_overrides": {
    "018f-question-id-2": 10,
    "018f-question-id-3": 15
  },
  "assembly_metadata": {
    "is_template": true,
    "template_category": "advanced_assessments",
    "target_audience": "advanced",
    "learning_objectives": [
      "Master advanced JavaScript concepts",
      "Apply design patterns effectively",
      "Optimize code performance"
    ]
  }
}
```

## Implementation Details

### CQRS Command Handler

The endpoint uses the CQRS pattern with the following command:

```java
public record AssembleQuizCommand(
    Long userId,
    String questionBankId,
    String quizAssemblyId,
    QuizMetadataDto quizMetadata,
    List<String> selectedQuestionIds,
    AssemblySettingsDto assemblySettings,
    Map<String, Integer> questionDisplayOrders,
    Map<String, Integer> pointsOverrides,
    AssemblyMetadataDto assemblyMetadata
) implements ICommand<QuizAssemblyResponseDto> {}
```

### Validation Chain

The implementation includes a comprehensive validation chain:

1. **QuestionBankOwnershipValidator**: Validates user owns the question bank
2. **SelectedQuestionsValidator**: Validates all questions exist and are published
3. **QuizAssemblyDataValidator**: Validates quiz metadata and settings
4. **DuplicateAssemblyIdValidator**: Prevents duplicate assembly IDs (for new assemblies)
5. **DisplayOrderValidator**: Ensures unique display orders
6. **PointsOverrideValidator**: Validates points override values

### Database Operations

The implementation uses MongoDB upsert operations:

```javascript
db.quiz_assemblies.findAndModify({
  query: {
    user_id: 12345,
    question_bank_id: "018f-a1b2-c3d4-e5f6-123456789abc",
    quiz_assembly_id: "018f-b2c3-d4e5-f6a7-234567890def"
  },
  update: { $set: quizAssemblyDocument },
  upsert: true,
  new: true
});
```

## Performance Considerations

1. **Batch Question Retrieval**: All selected questions retrieved in single query
2. **Snapshot Creation**: Question data embedded to avoid future joins
3. **Async Processing**: Large assemblies processed asynchronously if needed
4. **Connection Pooling**: Efficient database connection management

## Rate Limiting

- **Limit**: 20 quiz assembly operations per minute per user
- **Large Assemblies**: Additional throttling for assemblies with >50 questions
- **Burst Capacity**: Allow 5 operations in quick succession

```http
X-RateLimit-Limit: 20
X-RateLimit-Remaining: 18
X-RateLimit-Reset: 1696000060
```

This API provides comprehensive quiz assembly creation and update capabilities with robust validation, error handling, and performance optimization.