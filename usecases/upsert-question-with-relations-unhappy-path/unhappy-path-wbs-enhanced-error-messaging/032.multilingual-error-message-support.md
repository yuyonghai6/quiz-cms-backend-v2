# US-032: Multilingual Error Message Support

## User Story
**As a** global API consumer developing multilingual quiz applications
**I want** error messages and validation feedback in multiple languages
**So that** users worldwide can understand and resolve validation issues in their preferred language

## Epic
Enhanced Error Messaging

## Story
Implement comprehensive multilingual support for error messages, validation feedback, and recovery guidance with dynamic language detection and fallback mechanisms

## Acceptance Criteria

### Language Support Infrastructure
- [ ] **AC-032.1**: System must support configurable language preferences via request headers or user settings
- [ ] **AC-032.2**: Error messages must be translatable with proper internationalization (i18n) support
- [ ] **AC-032.3**: Language fallback mechanism must default to English when translations are unavailable
- [ ] **AC-032.4**: Dynamic language switching must be supported within user sessions

### Comprehensive Message Translation
- [ ] **AC-032.5**: All validation error messages must be translatable including field names and context
- [ ] **AC-032.6**: Recovery guidance and suggestions must be translated with culturally appropriate content
- [ ] **AC-032.7**: Question type specific instructions must be localized for different educational contexts
- [ ] **AC-032.8**: Error message parameters and placeholders must support localized formatting

### Cultural Adaptation
- [ ] **AC-032.9**: Date, time, and number formatting must follow locale-specific conventions
- [ ] **AC-032.10**: Educational terminology must be adapted for regional educational systems
- [ ] **AC-032.11**: Examples and sample data must be culturally relevant and appropriate
- [ ] **AC-032.12**: Right-to-left (RTL) language support must be provided for Arabic, Hebrew, and other RTL languages

## Technical Requirements

### Internationalization Infrastructure
```java
@Component
public class MultilingualErrorMessageResolver {

    private final MessageSource messageSource;
    private final LocaleResolver localeResolver;
    private final CulturalAdaptationService culturalService;
    private final ErrorMessageTemplateEngine templateEngine;

    public LocalizedErrorResponse localizeErrorResponse(
            DetailedErrorResponse errorResponse,
            HttpServletRequest request) {

        var locale = localeResolver.resolveLocale(request);
        var culturalContext = culturalService.getCulturalContext(locale);

        return LocalizedErrorResponse.builder()
            .success(errorResponse.isSuccess())
            .error(localizeErrorContext(errorResponse.getError(), locale, culturalContext))
            .suggestions(localizeSuggestions(errorResponse.getSuggestions(), locale, culturalContext))
            .relatedDocumentation(localizeDocumentation(errorResponse.getRelatedDocumentation(), locale))
            .locale(locale.toString())
            .textDirection(culturalContext.getTextDirection())
            .build();
    }

    private LocalizedErrorContext localizeErrorContext(
            DetailedErrorContext errorContext,
            Locale locale,
            CulturalContext culturalContext) {

        // 1. Localize main error message
        var localizedMessage = messageSource.getMessage(
            "error." + errorContext.getErrorCode(),
            extractMessageParameters(errorContext),
            errorContext.getMessage(), // fallback
            locale
        );

        // 2. Localize field names and paths
        var localizedFieldPaths = localizeFieldPaths(errorContext.getFieldPaths(), locale);

        // 3. Localize contextual information
        var localizedContext = localizeContextualInformation(errorContext, locale, culturalContext);

        return LocalizedErrorContext.builder()
            .errorCode(errorContext.getErrorCode())
            .message(localizedMessage)
            .timestamp(formatTimestamp(errorContext.getTimestamp(), culturalContext))
            .fieldPaths(localizedFieldPaths)
            .contextualInformation(localizedContext)
            .build();
    }

    private List<LocalizedSuggestion> localizeSuggestions(
            List<ContextualSuggestion> suggestions,
            Locale locale,
            CulturalContext culturalContext) {

        return suggestions.stream()
            .map(suggestion -> LocalizedSuggestion.builder()
                .title(messageSource.getMessage(
                    "suggestion.title." + suggestion.getCategory(),
                    null,
                    suggestion.getTitle(),
                    locale
                ))
                .description(messageSource.getMessage(
                    "suggestion.description." + suggestion.getCategory(),
                    extractSuggestionParameters(suggestion),
                    suggestion.getDescription(),
                    locale
                ))
                .steps(localizeSteps(suggestion.getSteps(), locale))
                .examplePayload(localizeExamplePayload(suggestion.getExamplePayload(), locale, culturalContext))
                .build())
            .collect(Collectors.toList());
    }
}
```

### Cultural Adaptation Service
```java
@Component
public class CulturalAdaptationService {

    private final Map<Locale, CulturalContext> culturalContexts;
    private final EducationalTerminologyService terminologyService;
    private final LocalizedExampleGenerator exampleGenerator;

    public CulturalContext getCulturalContext(Locale locale) {
        return culturalContexts.computeIfAbsent(locale, this::createCulturalContext);
    }

    private CulturalContext createCulturalContext(Locale locale) {
        return CulturalContext.builder()
            .locale(locale)
            .textDirection(determineTextDirection(locale))
            .dateTimePattern(getLocalizedDateTimePattern(locale))
            .numberFormat(getLocalizedNumberFormat(locale))
            .educationalTerminology(terminologyService.getTerminology(locale))
            .culturalExamples(exampleGenerator.generateExamples(locale))
            .build();
    }

    public LocalizedExamplePayload adaptExamplePayload(
            ExamplePayload originalPayload,
            Locale locale,
            CulturalContext context) {

        var adaptedPayload = LocalizedExamplePayload.builder()
            .questionType(originalPayload.getQuestionType())
            .locale(locale);

        switch (originalPayload.getQuestionType()) {
            case MULTIPLE_CHOICE:
                adaptedPayload.content(adaptMultipleChoiceExample(originalPayload, context));
                break;
            case TRUE_FALSE:
                adaptedPayload.content(adaptTrueFalseExample(originalPayload, context));
                break;
            case SHORT_ANSWER:
                adaptedPayload.content(adaptShortAnswerExample(originalPayload, context));
                break;
            case ESSAY:
                adaptedPayload.content(adaptEssayExample(originalPayload, context));
                break;
        }

        return adaptedPayload.build();
    }

    private MultipleChoiceExampleContent adaptMultipleChoiceExample(
            ExamplePayload payload,
            CulturalContext context) {

        // Use culturally appropriate subject matter and examples
        var culturalExamples = context.getCulturalExamples().getMultipleChoiceExamples();
        var selectedExample = selectAppropriateCulturalExample(culturalExamples);

        return MultipleChoiceExampleContent.builder()
            .questionText(localizeWithParameters(
                selectedExample.getQuestionTemplate(),
                context.getEducationalTerminology()
            ))
            .options(localizeOptions(selectedExample.getOptions(), context))
            .correctAnswers(selectedExample.getCorrectAnswers())
            .explanation(localizeWithParameters(
                selectedExample.getExplanationTemplate(),
                context.getEducationalTerminology()
            ))
            .build();
    }
}
```

### Localized Error Message Templates
```properties
# English (en) - messages.properties
error.QUESTION_TYPE_VALIDATION_FAILED=Question validation failed for {0} question type
error.INVALID_MULTIPLE_CHOICE_OPTIONS=Multiple choice questions require at least {0} options, but only {1} provided
error.MISSING_CORRECT_ANSWERS=Please specify at least one correct answer for the multiple choice question
suggestion.title.IMMEDIATE=Immediate Action Required
suggestion.description.IMMEDIATE=Follow these steps to resolve the validation error quickly

# Spanish (es) - messages_es.properties
error.QUESTION_TYPE_VALIDATION_FAILED=La validación de la pregunta falló para el tipo de pregunta {0}
error.INVALID_MULTIPLE_CHOICE_OPTIONS=Las preguntas de opción múltiple requieren al menos {0} opciones, pero solo se proporcionaron {1}
error.MISSING_CORRECT_ANSWERS=Por favor especifique al menos una respuesta correcta para la pregunta de opción múltiple
suggestion.title.IMMEDIATE=Acción Inmediata Requerida
suggestion.description.IMMEDIATE=Siga estos pasos para resolver el error de validación rápidamente

# French (fr) - messages_fr.properties
error.QUESTION_TYPE_VALIDATION_FAILED=La validation de la question a échoué pour le type de question {0}
error.INVALID_MULTIPLE_CHOICE_OPTIONS=Les questions à choix multiples nécessitent au moins {0} options, mais seulement {1} fournies
error.MISSING_CORRECT_ANSWERS=Veuillez spécifier au moins une réponse correcte pour la question à choix multiples
suggestion.title.IMMEDIATE=Action Immédiate Requise
suggestion.description.IMMEDIATE=Suivez ces étapes pour résoudre rapidement l'erreur de validation

# Arabic (ar) - messages_ar.properties
error.QUESTION_TYPE_VALIDATION_FAILED=فشل في التحقق من السؤال لنوع السؤال {0}
error.INVALID_MULTIPLE_CHOICE_OPTIONS=تتطلب أسئلة الاختيار من متعدد على الأقل {0} خيارات، ولكن تم توفير {1} فقط
error.MISSING_CORRECT_ANSWERS=يرجى تحديد إجابة صحيحة واحدة على الأقل لسؤال الاختيار من متعدد
suggestion.title.IMMEDIATE=مطلوب إجراء فوري
suggestion.description.IMMEDIATE=اتبع هذه الخطوات لحل خطأ التحقق بسرعة
```

### Locale-Aware Error Controller Enhancement
```java
@RestController
@RequestMapping("/api/questions")
public class LocalizedQuestionController {

    private final IMediator mediator; // From global-shared-library
    private final MultilingualErrorMessageResolver errorMessageResolver;
    private final LocaleResolver localeResolver;

    @PostMapping("/{questionBankId}/questions")
    public ResponseEntity<?> upsertQuestion(
            @PathVariable Long questionBankId,
            @RequestBody CreateQuestionRequest request,
            HttpServletRequest httpRequest) {

        var command = UpsertQuestionCommand.builder()
            .userId(getCurrentUserId())
            .questionBankId(questionBankId)
            .question(request.toQuestion())
            .build();

        var result = mediator.send(command);

        if (result.isSuccess()) {
            return ResponseEntity.ok(result.getValue());
        } else {
            // Localize error response based on request locale
            var locale = localeResolver.resolveLocale(httpRequest);
            var localizedError = errorMessageResolver.localizeErrorResponse(
                result.getDetailedError(),
                httpRequest
            );

            return ResponseEntity.badRequest()
                .header("Content-Language", locale.toString())
                .body(localizedError);
        }
    }
}
```

### Integration Points
- **US-028-030**: Localizes all enhanced error messages and recovery guidance
- **US-029**: Provides multilingual contextual error information
- **US-031**: Supports multilingual error analytics and tracking

## Business Rules

### Language Support Rules
1. **User Preference**: Language determined by user preference, request header, or browser settings
2. **Fallback Strategy**: English used as fallback when specific language translations unavailable
3. **Dynamic Switching**: Language can be changed dynamically within user sessions
4. **Complete Coverage**: All user-facing error messages must be translatable

### Cultural Adaptation Rules
1. **Educational Context**: Educational terminology adapted for regional educational systems
2. **Cultural Sensitivity**: Examples and content culturally appropriate and sensitive
3. **Formatting Standards**: Dates, numbers, and text direction follow locale conventions
4. **Professional Standards**: Translations maintain professional technical accuracy

### Translation Quality Rules
1. **Technical Accuracy**: Technical terms translated accurately with proper context
2. **Consistency**: Translation terminology consistent across all error messages
3. **Clarity**: Translated messages maintain clarity and actionability of original English
4. **Cultural Appropriateness**: Translations respect cultural norms and expectations

## Definition of Done

### Internationalization Infrastructure
- [ ] MultilingualErrorMessageResolver with comprehensive localization support
- [ ] Language detection and fallback mechanism with user preference integration
- [ ] Cultural adaptation service with locale-specific formatting and content
- [ ] Localized error message templates for major languages (English, Spanish, French, German, Arabic, Chinese, Japanese)

### Translation Coverage
- [ ] All validation error messages translated with proper parameter support
- [ ] Recovery guidance and suggestions localized with cultural adaptation
- [ ] Question type specific instructions localized for different educational contexts
- [ ] Documentation references localized with region-appropriate content

### Cultural Adaptation
- [ ] Date, time, and number formatting following locale conventions
- [ ] Educational terminology adapted for regional educational systems
- [ ] RTL language support for Arabic, Hebrew, and other RTL languages
- [ ] Culturally appropriate examples and sample data for each supported locale

### Integration and Testing
- [ ] Localized error controller integration with existing validation chain
- [ ] Comprehensive testing with native speakers for translation accuracy
- [ ] Performance testing ensuring localization doesn't impact response times
- [ ] Cultural appropriateness validation with regional education experts

## Dependencies

### Prerequisites
- **US-028**: Type-specific validation errors for comprehensive message localization
- **US-029**: Contextual error information for complete context localization
- **US-030**: Error recovery guidance for recovery strategy localization

### External Dependencies
- Spring MessageSource configuration for internationalization
- Professional translation services for accurate technical translations
- Cultural consultation for educational terminology adaptation
- Locale-specific formatting libraries for proper number and date formatting

## Risk Mitigation

### Translation Quality Risks
- **Technical Accuracy**: Professional technical translators with software development experience
- **Cultural Sensitivity**: Regional educational experts review translations for appropriateness
- **Consistency**: Translation memory and terminology databases ensure consistency
- **Maintenance**: Translation update processes ensure new messages are promptly translated

### Performance Risks
- **Localization Overhead**: Efficient message caching and locale-specific optimization
- **Memory Usage**: Optimized message loading with lazy loading for unused locales
- **Response Time**: Localization performance testing ensures acceptable response times
- **Scalability**: Locale-specific caching strategies for high-traffic multilingual scenarios

### Cultural and Regional Risks
- **Educational Context**: Regional education system experts validate terminology appropriateness
- **Cultural Sensitivity**: Cultural review processes prevent inappropriate content
- **Legal Compliance**: Translations comply with regional data protection and accessibility laws
- **User Experience**: Native speaker user testing validates translation effectiveness

## Success Metrics

### Translation Coverage
- 100% of user-facing error messages available in top 7 supported languages
- Translation accuracy score >95% validated by native speakers
- Cultural appropriateness score >90% validated by regional education experts
- Translation consistency score >98% across all error message categories

### User Experience
- Multilingual user satisfaction score >85% for error message clarity
- Error resolution time for non-English users reduced by 40% with native language support
- Support ticket volume in non-English languages reduced by 70%
- User retention rate improved by 25% in non-English markets

### System Performance
- Localization adds <20ms to error response generation time
- Translation cache hit rate >95% for active locales
- Memory usage for localization <100MB per active locale
- Multilingual error analytics accuracy >90% across all supported languages